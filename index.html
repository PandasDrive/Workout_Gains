<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <!-- These tags are what make it feel like a PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sculpted Fitness Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent; /* Removes blue flash on tap */
            background-color: #111827; /* Same as bg-gray-900 */
            color: #e5e7eb; /* Same as text-gray-200 */
            min-height: 100vh;
            position: relative;
        }
        .btn-press {
            transition: all 0.1s ease;
        }
        .btn-press:active {
            transform: scale(0.98);
            filter: brightness(0.9);
        }
        
        /* Page Navigation System */
        .no-js .page {
            position: static;
            display: block;
            animation: none;
            padding: 1.5rem;
        }
        .no-js .page + .page {
            margin-top: 2rem;
        }
        .js-enabled .page {
            display: none; /* Hidden by default when JS is enabled */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transform: translateY(16px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .js-enabled .page.active {
            display: block; /* Show active page */
        }
        .js-enabled .page.entering {
            opacity: 0;
            transform: translateY(16px);
        }
        .js-enabled .page.entered {
            opacity: 1;
            transform: translateY(0);
        }
        .js-enabled .page.leaving {
            opacity: 0;
            transform: translateY(-16px);
        }
        .page-content {
            --page-padding-x: 1.5rem;
            --page-padding-top: calc(1.5rem + env(safe-area-inset-top, 0px));
            --page-padding-bottom: calc(8rem + env(safe-area-inset-bottom, 0px));
            min-height: 100vh;
            height: 100%;
            overflow-y: auto;
            padding: var(--page-padding-top) var(--page-padding-x) var(--page-padding-bottom);
        }
        .no-js .page-content {
            height: auto;
            overflow: visible;
            padding: 1rem 0;
        }
        .page-content--menu {
            --page-padding-x: clamp(1.25rem, 4vw, 2.5rem);
            --page-padding-top: calc(2.5rem + env(safe-area-inset-top, 0px));
            --page-padding-bottom: calc(3.5rem + env(safe-area-inset-bottom, 0px));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 2.5rem;
        }
        #page-workout-details .page-content {
            --page-padding-bottom: calc(9rem + env(safe-area-inset-bottom, 0px));
        }
        @media (min-width: 768px) {
            .page-content--menu {
                justify-content: center;
            }
        }
        /* Style for the header on sub-pages */
        .page-header {
            position: sticky;
            top: 0;
            background-color: #111827; 
            padding-top: calc(1.5rem + env(safe-area-inset-top, 0px));
            padding-bottom: 1rem;
            border-bottom: 1px solid #374151; 
            z-index: 10;
        }
        .continue-card {
            border: 1px solid #2563eb33;
            background: linear-gradient(135deg, rgba(37,99,235,0.15), rgba(59,130,246,0.05));
        }
        .trainer-card {
            position: relative;
            overflow: hidden;
            padding: 0;
            background-color: #1f2937;
        }
        .trainer-card-bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            opacity: 0.35;
            transition: opacity 0.2s ease;
        }
        .trainer-card-shade {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(17,24,39,0.8), rgba(37,99,235,0.15));
            transition: opacity 0.2s ease;
        }
        .trainer-card:hover .trainer-card-bg {
            opacity: 0.5;
        }
        .trainer-card:hover .trainer-card-shade {
            opacity: 0.7;
        }

        /* Splash Intro */
        #splash-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at center, rgba(17, 24, 39, 0.96), rgba(10, 12, 28, 0.98));
            z-index: 70;
            transition: opacity 0.6s ease;
            perspective: 1200px;
            -webkit-perspective: 1200px;
            overflow: hidden;
            transform-style: preserve-3d;
            -webkit-transform-style: preserve-3d;
        }
        #splash-overlay.is-hidden {
            opacity: 0;
            pointer-events: none;
        }
        .splash-carousel {
            position: relative;
            width: min(76vw, 420px);
            height: min(76vw, 420px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.6s ease;
            will-change: opacity;
        }
        .splash-carousel.ready {
            opacity: 1;
        }
        #splash-cards {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }
        .splash-card {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 148px;
            height: 76px;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            border: 1px solid rgba(59, 130, 246, 0.28);
            box-shadow: 0 16px 45px rgba(37, 99, 235, 0.28);
            overflow: hidden;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.38) rotate(0deg);
            transform-origin: center;
            visibility: hidden;
            transition: transform 0.7s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.65s ease;
            will-change: transform, opacity;
        }
        .splash-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
        }
        .splash-card.burst-enter {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(0.68) rotate(var(--entry-tilt, 0deg));
        }
        .splash-card.burst-enter.burst-fanned {
            transform: translate(-50%, -50%) translate(var(--fan-x, 0px), var(--fan-y, 0px)) rotate(var(--fan-tilt, 0deg)) scale(1);
        }
        .splash-card.fan-exit {
            transform: translate(-50%, -50%) scale(0.28) rotate(var(--fan-tilt, 0deg));
            opacity: 0;
        }
        .splash-card-bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            filter: saturate(1.1);
        }
        .splash-card-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(140deg, rgba(17, 24, 39, 0.76), rgba(17, 24, 39, 0.25));
            display: flex;
            align-items: flex-end;
            padding: 0.55rem 0.75rem;
        }
        .splash-card-name {
            display: block;
            text-transform: uppercase;
            font-size: 0.78rem;
            letter-spacing: 0.08em;
            font-weight: 600;
            color: rgba(248, 250, 252, 0.92);
        }
        .trainer-card.card-await {
            opacity: 0;
            transform: translateY(26px) scale(0.97);
        }
        .trainer-card.card-fly-in {
            animation: trainer-card-fly-in 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards;
            animation-delay: var(--card-delay, 0s);
        }

        @keyframes trainer-card-fly-in {
            0% {
                opacity: 0;
                transform: translateY(24px) scale(0.96);
            }
            60% {
                opacity: 1;
                transform: translateY(-4px) scale(1.01);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        @media (max-width: 480px) {
            .splash-card {
                width: 124px;
                height: 68px;
                padding: 0.65rem 0.9rem;
            }
            .splash-card-name {
                font-size: 0.75rem;
            }
        }
        .search-trigger {
            border: 1px solid #374151;
        }
        .search-overlay {
            position: fixed;
            inset: 0;
            background: rgba(17,24,39,0.95);
            display: none;
            flex-direction: column;
            padding: 2.5rem 1.5rem;
            z-index: 50;
        }
        .search-overlay.active {
            display: flex;
        }
        .search-input {
            background-color: #1f2937;
            border: 1px solid #374151;
        }
        .search-result {
            border: 1px solid #1f2937;
        }
        .stats-overlay {
            position: fixed;
            inset: 0;
            background: rgba(17,24,39,0.92);
            display: none;
            flex-direction: column;
            padding: 2.5rem 1.5rem;
            z-index: 55;
        }
        .stats-overlay.active {
            display: flex;
        }

        .collapsible-card {
            overflow: hidden;
            transition: max-height 0.35s ease;
            max-height: 0;
        }
        .collapsible-card.expanded {
            max-height: 20000px;
        }
        .collapsible-trigger {
            cursor: pointer;
        }
        .collapsible-trigger .icon-rotate {
            transition: transform 0.2s ease;
        }
        .collapsible-trigger[aria-expanded="true"] .icon-rotate {
            transform: rotate(90deg);
        }

        .metric-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            border-radius: 9999px;
            border: 1px solid var(--metric-color, rgba(59, 130, 246, 0.35));
            background: linear-gradient(135deg, color-mix(in srgb, var(--metric-color, rgba(59,130,246,0.3)) 20%, rgba(17,24,39,0.9)), rgba(17, 24, 39, 0.9));
            box-shadow: 0 4px 10px color-mix(in srgb, var(--metric-color, rgba(59,130,246,0.3)) 25%, transparent);
            text-transform: uppercase;
            font-size: 0.65rem;
            letter-spacing: 0.12em;
            color: rgba(191, 219, 254, 0.85);
        }

        .metric-badge-dot {
            display: inline-block;
            width: 0.45rem;
            height: 0.45rem;
            border-radius: 9999px;
            background: var(--metric-color, rgba(96, 165, 250, 0.9));
            box-shadow: 0 0 4px color-mix(in srgb, var(--metric-color, rgba(96,165,250,0.9)) 40%, transparent);
        }

        .metric-badge-label {
            color: rgba(191, 219, 254, 0.7);
        }

        .metric-badge-value {
            color: rgba(219, 234, 254, 0.95);
            text-transform: none;
            letter-spacing: 0;
            font-weight: 600;
        }

        .metric-badge--sets {
            --metric-color: rgba(167, 139, 250, 0.45);
        }

        .metric-badge--reps {
            --metric-color: rgba(96, 165, 250, 0.45);
        }

        .metric-badge--rest {
            --metric-color: rgba(248, 180, 127, 0.45);
        }

        .metric-badge--info {
            --metric-color: rgba(94, 234, 212, 0.4);
        }
        .metric-badge--info .metric-badge-label {
            color: rgba(191, 219, 254, 0.6);
        }

        .group-block {
            border-radius: 1rem;
            padding: 1.25rem;
        }

        .group-block--superset {
            border: 1px solid rgba(251, 191, 36, 0.25);
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.08), rgba(17, 24, 39, 0.92));
        }

        .group-block--giant {
            border: 1px solid rgba(94, 234, 212, 0.2);
            background: linear-gradient(135deg, rgba(94, 234, 212, 0.08), rgba(17, 24, 39, 0.92));
        }

        .group-heading {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .group-label {
            font-size: 0.7rem;
            letter-spacing: 0.28em;
            text-transform: uppercase;
            font-weight: 600;
        }

        .group-caption {
            font-size: 0.75rem;
            color: rgba(229, 231, 235, 0.6);
        }

        .group-block--superset .group-label {
            color: rgba(251, 191, 36, 0.8);
        }

        .group-block--giant .group-label {
            color: rgba(94, 234, 212, 0.75);
        }

        .group-block--triple {
            border: 1px solid rgba(129, 140, 248, 0.25);
            background: linear-gradient(135deg, rgba(129, 140, 248, 0.08), rgba(17, 24, 39, 0.92));
        }

        .group-block--triple .group-label {
            color: rgba(165, 180, 252, 0.8);
        }

        .group-block--circuit {
            border: 1px solid rgba(45, 212, 191, 0.3);
            background: linear-gradient(135deg, rgba(45, 212, 191, 0.08), rgba(17, 24, 39, 0.92));
        }

        .group-block--circuit .group-label {
            color: rgba(45, 212, 191, 0.8);
        }
    </style>
</head>
<body class="no-js h-full text-gray-200 antialiased">

    <div id="splash-overlay">
        <div class="splash-carousel" id="splash-carousel">
            <div id="splash-cards"></div>
        </div>
    </div>

    <!-- Page 1: Main Menu -->
    <div id="page-main-menu" class="page active">
        <div class="page-content page-content--menu bg-gray-900">
            <header class="w-full max-w-xl mx-auto text-center">
                <h1 class="text-4xl font-bold text-white mb-2">Sculpted Fitness Tracker</h1>
                <p class="text-lg text-gray-400">Your personal program tracker.</p>
            </header>
            <main class="w-full max-w-xl mx-auto space-y-6">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="text-left">
                        <p class="text-sm uppercase tracking-widest text-blue-400">Welcome Back</p>
                        <p class="text-2xl font-semibold text-white">Your Programs</p>
                    </div>
                    <button id="open-search" class="search-trigger btn-press px-4 py-2 rounded-xl flex items-center justify-center text-sm font-medium text-blue-300 hover:text-white w-full sm:w-auto">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M10 18a8 8 0 100-16 8 8 0 000 16z"></path></svg>
                        Search Workouts
                    </button>
                </div>

                <div id="continue-card" class="continue-card hidden rounded-2xl p-5 flex flex-col md:flex-row md:items-center md:justify-between">
                    <div class="mb-4 md:mb-0">
                        <p class="text-sm uppercase tracking-wider text-blue-300">Continue</p>
                        <p id="continue-title" class="text-lg font-semibold text-white"></p>
                        <p id="continue-subtitle" class="text-sm text-gray-300"></p>
                    </div>
                    <div class="space-y-2 md:space-y-0 md:space-x-3 md:flex">
                        <button id="continue-btn" class="btn-press bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">Resume Workout</button>
                        <button id="reset-progress" class="btn-press text-sm text-gray-300 hover:text-white px-4 py-2 rounded-lg border border-transparent">Reset</button>
                    </div>
                </div>

                <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider text-center">Select a Trainer</h2>
                <div id="trainer-card-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>

                <div class="space-y-4">
                    <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6 shadow-lg flex flex-col md:flex-row md:items-center md:justify-between">
                        <div class="mb-4 md:mb-0">
                            <p class="text-sm uppercase tracking-wider text-blue-300">Progress Hub</p>
                            <p class="text-lg font-semibold text-white">Visualize & Backup Your Journey</p>
                            <p class="text-sm text-gray-400">Review completed weeks, compare past runs, and export your data at any time.</p>
                        </div>
                        <div class="space-y-3 md:space-y-0 md:space-x-3 md:flex">
                            <button id="open-stats" class="btn-press bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">View Progress</button>
                            <button id="quick-export" class="btn-press px-4 py-2 rounded-lg border border-gray-600 text-sm text-gray-200 hover:text-white">Quick Export</button>
                        </div>
                    </div>
                    <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6 shadow-lg flex flex-col md:flex-row md:items-center md:justify-between">
                        <div class="mb-4 md:mb-0">
                            <p class="text-sm uppercase tracking-wider text-blue-300">Meal Prep</p>
                            <p class="text-lg font-semibold text-white">Nutrition Hub</p>
                            <p class="text-sm text-gray-400">Browse recipes, plan meals, and generate shopping lists from the 80 Wholefoods guide.</p>
                        </div>
                        <div>
                            <a href="nutrition.html" class="btn-press inline-flex items-center bg-blue-500/20 hover:bg-blue-500/30 text-blue-200 text-sm font-medium rounded-xl px-4 py-2">Open Nutrition Hub</a>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Page 2: Trainer Programs -->
    <div id="page-trainer-programs" class="page">
        <div class="page-content bg-gray-900">
            <header class="page-header flex items-center justify-between mb-6">
                <button onclick="showPage('page-main-menu')" class="btn-press flex items-center text-blue-400 text-lg">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Home
                </button>
                <h1 id="trainer-title" class="text-2xl font-bold text-white text-right"></h1>
            </header>
            <main id="trainer-program-list" class="space-y-3"></main>
        </div>
    </div>

    <!-- Page 3: Week List -->
    <div id="page-program-weeks" class="page">
        <div class="page-content bg-gray-900">
            <header class="page-header flex items-center justify-between mb-6">
                <button onclick="goToTrainerPage()" class="btn-press flex items-center text-blue-400 text-lg">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Trainers
                </button>
                <h1 id="program-title" class="text-2xl font-bold text-white text-right"></h1>
            </header>
            <main id="week-list" class="space-y-3"></main>
        </div>
    </div>

    <!-- Page 3: Day List -->
    <div id="page-week-days" class="page">
        <div class="page-content bg-gray-900">
            <header class="page-header flex items-center justify-between mb-6">
                <button onclick="showProgram(currentProgram)" class="btn-press flex items-center text-blue-400 text-lg">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Weeks
                </button>
                <h1 id="week-title" class="text-2xl font-bold text-white text-right"></h1>
            </header>
            <main id="day-list" class="space-y-3"></main>
        </div>
    </div>

    <!-- Page 4: Workout Details -->
    <div id="page-workout-details" class="page">
        <div class="page-content bg-gray-900">
            <header class="page-header flex items-center justify-between mb-6">
                <button onclick="showWeek(currentProgram, currentWeek)" class="btn-press flex items-center text-blue-400 text-lg">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Days
                </button>
                <h1 id="day-title" class="text-xl font-bold text-white text-right"></h1>
            </header>
            
            <!-- Main workout content -->
            <main id="workout-content" class="space-y-6"></main>

            <!-- Complete button -->
            <div class="fixed bottom-0 left-0 right-0 p-4 bg-gray-900 border-t border-gray-700">
                <button onclick="completeWorkout()" class="btn-press w-full py-4 px-6 bg-blue-600 hover:bg-blue-700 text-white text-lg font-semibold rounded-xl shadow-lg">
                    Complete Workout
                </button>
            </div>
        </div>
    </div>

    <!-- Message box for alerts -->
    <div id="message-box" class="hidden fixed bottom-24 left-1/2 -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-xl shadow-lg z-50">
        <p id="message-text"></p>
    </div>

    <!-- Weekly Summary Modal -->
    <div id="summary-overlay" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl max-w-xl w-full p-6 space-y-5 shadow-2xl">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm uppercase tracking-widest text-blue-400">Weekly Snapshot</p>
                    <h2 id="summary-title" class="text-2xl font-semibold text-white"></h2>
                </div>
                <button id="close-summary" class="btn-press text-gray-400 hover:text-white">Close</button>
            </div>
            <div class="bg-gray-800 rounded-xl border border-gray-700 p-4 space-y-3">
                <div>
                    <p class="text-xs uppercase tracking-wider text-gray-400">Cardio Completed</p>
                    <p id="summary-cardio" class="text-lg font-semibold text-white"></p>
                </div>
                <div>
                    <p class="text-xs uppercase tracking-wider text-gray-400">Weekly Task</p>
                    <p id="summary-task" class="text-sm text-gray-300"></p>
                </div>
                <div>
                    <p class="text-xs uppercase tracking-wider text-gray-400">Notes Entered</p>
                    <ul id="summary-notes" class="text-sm text-gray-300 space-y-1"></ul>
                </div>
            </div>
            <div>
                <p class="text-xs uppercase tracking-wider text-gray-400">Historical Notes</p>
                <div id="summary-history" class="bg-gray-800 rounded-xl border border-gray-700 p-4 space-y-3 max-h-48 overflow-y-auto text-sm text-gray-300"></div>
            </div>
        </div>
    </div>

    <!-- Stats & Backup Overlay -->
    <div id="stats-overlay" class="stats-overlay">
        <div class="flex items-center justify-between mb-6">
            <div>
                <p class="text-sm uppercase tracking-widest text-blue-400">Progress & Backup</p>
                <h2 class="text-2xl font-semibold text-white">Your Training History</h2>
            </div>
            <button id="close-stats" class="btn-press text-gray-400 hover:text-white">Close</button>
        </div>
        <div id="stats-empty" class="flex-1 flex items-center justify-center text-gray-500 text-center hidden">
            <div>
                <p class="text-lg font-semibold text-gray-300">No completed weeks yet.</p>
                <p class="text-sm text-gray-400 mt-2">Log notes and finish a week to start building your history.</p>
            </div>
        </div>
        <div id="stats-content" class="flex-1 space-y-6 overflow-y-auto">
            <div class="bg-gray-900 border border-gray-700 rounded-2xl p-4">
                <canvas id="progress-chart" height="220"></canvas>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-gray-900 border border-gray-700 rounded-2xl p-4">
                    <p class="text-xs uppercase tracking-wider text-gray-400">Totals</p>
                    <div class="mt-3 space-y-2">
                        <p class="text-sm text-gray-300">Completed Weeks: <span id="stats-weeks" class="text-blue-300 font-semibold">0</span></p>
                        <p class="text-sm text-gray-300">Notes Captured: <span id="stats-notes" class="text-blue-300 font-semibold">0</span></p>
                        <p class="text-sm text-gray-300">Programs Logged: <span id="stats-programs" class="text-blue-300 font-semibold">0</span></p>
                    </div>
                </div>
                <div class="bg-gray-900 border border-gray-700 rounded-2xl p-4 space-y-3">
                    <p class="text-xs uppercase tracking-wider text-gray-400">Backup & Restore</p>
                    <p class="text-sm text-gray-400">Export your notes, progress, and history for safe keeping—or import a previous backup to restore everything.</p>
                    <div class="space-y-2">
                        <button id="export-data" class="btn-press w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">Download Backup</button>
                        <button id="import-data" class="btn-press w-full px-4 py-2 rounded-lg border border-gray-600 text-sm text-gray-200 hover:text-white">Import Backup</button>
                        <input type="file" id="import-input" accept="application/json" class="hidden" />
                    </div>
                </div>
            </div>
            <div class="bg-gray-900 border border-gray-700 rounded-2xl p-4">
                <p class="text-xs uppercase tracking-wider text-gray-400">Recent History</p>
                <div id="stats-history" class="mt-3 space-y-3 text-sm text-gray-300"></div>
            </div>
        </div>
    </div>

    <!-- ThenX Library Page -->
    <div id="page-thenx-library" class="page">
        <div class="page-header px-6">
            <div class="flex items-center justify-between">
                <button id="thenx-library-back" class="btn-press text-sm text-gray-300 hover:text-white flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Back to Trainer
                </button>
                <div class="text-right">
                    <p class="text-xs uppercase tracking-wider text-blue-300">Calisthenics Library</p>
                    <h1 id="thenx-library-title" class="text-2xl font-semibold text-white">ThenX Calisthenics Library</h1>
                </div>
            </div>
        </div>
        <div class="page-content space-y-6">
            <div class="bg-gray-900 border border-gray-700 rounded-2xl p-5 space-y-4">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <p id="thenx-library-summary" class="text-sm text-gray-300">Explore signature bodyweight circuits curated from ThenX featured workouts.</p>
                    <div class="w-full md:w-80">
                        <input id="thenx-search-input" type="text" placeholder="Search workouts..." class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="w-full sm:flex-1">
                        <div class="overflow-x-auto -mx-1 sm:mx-0">
                            <div id="thenx-focus-chips" class="inline-flex gap-2 px-1 sm:px-0 whitespace-nowrap"></div>
                        </div>
                    </div>
                    <button id="thenx-clear-filters" class="btn-press text-xs sm:text-sm text-gray-300 hover:text-white border border-gray-700 rounded-full px-3 py-1">Clear Filters</button>
                </div>
            </div>
            <div id="thenx-library-empty" class="hidden text-center text-gray-400 bg-gray-900 border border-gray-700 rounded-2xl p-8">
                <p class="text-lg font-semibold text-gray-300">No workouts match your filters yet.</p>
                <p class="text-sm text-gray-400 mt-2">Try clearing the filters or searching with a different keyword.</p>
            </div>
            <div id="thenx-workout-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
        </div>
    </div>

    <!-- Search Overlay -->
    <div id="search-overlay" class="search-overlay">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-semibold text-white">Search Exercises</h2>
            <button id="close-search" class="btn-press text-gray-400 hover:text-white text-sm">Close</button>
        </div>
        <div class="mb-6">
            <input id="search-input" type="text" placeholder="Search by exercise name..." class="search-input w-full px-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-white placeholder-gray-500" />
            <p class="text-sm text-gray-400 mt-2">Tip: try "squat", "pulldown", or "DTP".</p>
        </div>
        <div id="search-results" class="overflow-y-auto space-y-3"></div>
    </div>

    <script src="data/thenx-workouts.js"></script>
    <script src="data/program-data.js"></script>
    <script>
        document.body.classList.remove('no-js');
        document.body.classList.add('js-enabled');

        // --- DATABASE ---
        const programs = window.programs || {};
        if (!Object.keys(programs).length) {
            console.warn("Program data is not loaded.");
        }

        const thenxDataset = window.thenxWorkouts || { workouts: [], source: '', updatedAt: '' };
        const thenxLibraryWorkouts = (thenxDataset.workouts || []).map((workout) => {
            const focus = Array.isArray(workout.focus) ? workout.focus : [];
            let level = 'all';
            try {
                const params = new URL(workout.url, window.location.origin).searchParams;
                level = (params.get('level') || 'all').toLowerCase();
            } catch (error) {
                level = 'all';
            }
            const focusLower = focus.map(tag => tag.toLowerCase());
            const searchHaystack = [workout.title || '', focusLower.join(' ')]
                .join(' ')
                .toLowerCase();
            return {
                ...workout,
                focus,
                focusLower,
                level,
                searchHaystack,
            };
        }).sort((a, b) => (b.likes ?? 0) - (a.likes ?? 0));

        const thenxFocusOptions = Array.from(new Set(thenxLibraryWorkouts.flatMap(workout => workout.focusLower))).filter(Boolean).sort();
        const THENX_FAVORITES_KEY = 'thenxFavorites';
        const THENX_SEARCH_LIMIT = 60;
        const THENX_SEARCH_DELAY = 120;
        let thenxFavorites = loadThenxFavorites();

        if (!programs.thenxLibrary) {
            programs.thenxLibrary = {
                title: "ThenX Calisthenics Library",
                type: "library",
                workouts: thenxLibraryWorkouts,
                source: thenxDataset.source || "https://app.thenx.com/featured-workouts",
                updatedAt: thenxDataset.updatedAt || ''
            };
        }

        const trainers = {
            gethin: {
                name: "Kris Gethin",
                image: "images/kris.PNG",
                programs: [
                    { id: "gethin", subtitle: "Legacy Program", image: "images/gethin_legacy.PNG", imagePosition: "center top 25%" },
                    { id: "kagedLean", subtitle: "Lean Muscle Trainer", image: "images/12_week_lean_muscle.PNG", imagePosition: "center top 28%" },
                    { id: "hardcore8", subtitle: "8-Week Hardcore Trainer", image: "images/hard.core.PNG", imagePosition: "center" }
                ]
            },
            nippard: {
                name: "Jeff Nippard",
                image: "images/jeff.PNG",
                imagePosition: "center top 18%",
                programs: [
                    { id: "nippard", subtitle: "12-Week Program", image: "images/jeff.nippard.program.PNG", imagePosition: "center top 20%" }
                ]
            },
            thenx: {
                name: "Chris Heria",
                image: "images/chris.heria.PNG",
                imagePosition: "center top 25%",
                programs: [
                    { id: "thenxLibrary", subtitle: "Calisthenics Library", image: "images/thenx.cali.libary.PNG", imagePosition: "center top 40%" }
                ]
            },
            tawna: {
                name: "Tawna Eubanks",
                image: "images/tawna.eubank.PNG",
                imagePosition: "center top 28%",
                programs: [
                    { id: "tawnaBikini", subtitle: "Bikini Trainer", image: "images/biki.8.week.PNG", imagePosition: "center top 35%" }
                ]
            }
        };

        const PROGRESS_KEY = 'fitnessProgress';
        const NOTES_KEY = 'fitnessNotes';
        const HISTORY_KEY = 'fitnessHistory';
        const trainerCardContainer = document.getElementById('trainer-card-container');
        const trainerProgramList = document.getElementById('trainer-program-list');
        const trainerTitle = document.getElementById('trainer-title');
        const continueCard = document.getElementById('continue-card');
        const continueTitle = document.getElementById('continue-title');
        const continueSubtitle = document.getElementById('continue-subtitle');
        const continueBtn = document.getElementById('continue-btn');
        const resetProgressBtn = document.getElementById('reset-progress');
        const searchOverlay = document.getElementById('search-overlay');
        const openSearchBtn = document.getElementById('open-search');
        const closeSearchBtn = document.getElementById('close-search');
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const thenxLibraryBack = document.getElementById('thenx-library-back');
        const thenxLibraryTitle = document.getElementById('thenx-library-title');
        const thenxLibrarySummary = document.getElementById('thenx-library-summary');
        const thenxFocusChipContainer = document.getElementById('thenx-focus-chips');
        const thenxWorkoutList = document.getElementById('thenx-workout-list');
        const thenxLibraryEmpty = document.getElementById('thenx-library-empty');
        const thenxSearchInput = document.getElementById('thenx-search-input');
        const thenxClearFiltersBtn = document.getElementById('thenx-clear-filters');
        const openStatsBtn = document.getElementById('open-stats');
        let thenxFilterState = { focus: 'all', search: '' };
        const quickExportBtn = document.getElementById('quick-export');
        const statsOverlay = document.getElementById('stats-overlay');
        const closeStatsBtn = document.getElementById('close-stats');
        const exportDataBtn = document.getElementById('export-data');
        const importDataBtn = document.getElementById('import-data');
        const importInput = document.getElementById('import-input');
        const statsEmpty = document.getElementById('stats-empty');
        const statsContent = document.getElementById('stats-content');
        const statsWeeks = document.getElementById('stats-weeks');
        const statsNotes = document.getElementById('stats-notes');
        const statsPrograms = document.getElementById('stats-programs');
        const statsHistoryContainer = document.getElementById('stats-history');
        const progressChartCanvas = document.getElementById('progress-chart');
        const summaryOverlay = document.getElementById('summary-overlay');
        const closeSummaryBtn = document.getElementById('close-summary');
        const summaryTitle = document.getElementById('summary-title');
        const summaryCardio = document.getElementById('summary-cardio');
        const summaryTask = document.getElementById('summary-task');
        const summaryNotes = document.getElementById('summary-notes');
        const summaryHistory = document.getElementById('summary-history');
        const splashOverlay = document.getElementById('splash-overlay');
        const splashCarousel = document.getElementById('splash-carousel');
        const splashCardsContainer = document.getElementById('splash-cards');
        let searchIndex = [];
        let notesCache = loadNotes();
        let historyCache = loadHistory();
        let pendingNavigation = null;
        let progressChartInstance = null;
        let thenxSearchTimeout = null;

        function loadProgress() {
            try {
                const stored = localStorage.getItem(PROGRESS_KEY);
                return stored ? JSON.parse(stored) : null;
            } catch (err) {
                console.error('Failed to load progress', err);
                return null;
            }
        }

        function loadNotes() {
            try {
                const stored = localStorage.getItem(NOTES_KEY);
                return stored ? JSON.parse(stored) : {};
            } catch (err) {
                console.error('Failed to load notes', err);
                return {};
            }
        }

        function saveNotes(notes) {
            try {
                localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
                notesCache = notes;
            } catch (err) {
                console.error('Failed to save notes', err);
            }
        }

        function loadHistory() {
            try {
                const stored = localStorage.getItem(HISTORY_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (err) {
                console.error('Failed to load history', err);
                return [];
            }
        }

        function saveHistory(history) {
            try {
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                historyCache = history;
            } catch (err) {
                console.error('Failed to save history', err);
            }
        }

        function getWeekNotes(programId, weekNumber) {
            return (notesCache[programId] && notesCache[programId][weekNumber]) ? { ...notesCache[programId][weekNumber] } : {};
        }

        function getDayNote(programId, weekNumber, dayNumber) {
            const programNotes = notesCache[programId];
            if (!programNotes) return '';
            const weekNotes = programNotes[weekNumber];
            if (!weekNotes) return '';
            return weekNotes[dayNumber] || '';
        }

        function setDayNote(programId, weekNumber, dayNumber, value) {
            if (!notesCache[programId]) {
                notesCache[programId] = {};
            }
            if (!notesCache[programId][weekNumber]) {
                notesCache[programId][weekNumber] = {};
            }
            if (value && value.trim()) {
                notesCache[programId][weekNumber][dayNumber] = value.trim();
            } else {
                delete notesCache[programId][weekNumber][dayNumber];
                if (Object.keys(notesCache[programId][weekNumber]).length === 0) {
                    delete notesCache[programId][weekNumber];
                }
            }
            saveNotes(notesCache);
            if (statsOverlay.classList.contains('active')) {
                renderStatsView();
            }
        }

        function collectExportData() {
            return {
                version: 1,
                generatedAt: new Date().toISOString(),
                progress: loadProgress(),
                notes: notesCache,
                history: historyCache
            };
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const anchor = document.createElement('a');
            anchor.href = url;
            anchor.download = filename;
            document.body.appendChild(anchor);
            anchor.click();
            document.body.removeChild(anchor);
            URL.revokeObjectURL(url);
        }

        function triggerExport() {
            const data = collectExportData();
            const timestamp = new Date().toISOString().split('T')[0];
            downloadJSON(data, `sculpted-fitness-backup-${timestamp}.json`);
            showMessage('Backup downloaded');
        }

        function aggregateCurrentNoteCount() {
            let total = 0;
            Object.values(notesCache).forEach(weekMap => {
                if (weekMap && typeof weekMap === 'object') {
                    Object.values(weekMap).forEach(dayNote => {
                        if (typeof dayNote === 'string' && dayNote.trim()) {
                            total += 1;
                        }
                    });
                }
            });
            return total;
        }

        function renderStatsView() {
            if (!statsOverlay) return;

            const hasHistory = historyCache.length > 0;
            const currentNotes = aggregateCurrentNoteCount();

            if (!hasHistory && currentNotes === 0) {
                statsEmpty.classList.remove('hidden');
                statsContent.classList.add('hidden');
                statsHistoryContainer.innerHTML = '';
                statsWeeks.textContent = '0';
                statsNotes.textContent = '0';
                statsPrograms.textContent = '0';
                if (progressChartInstance) {
                    progressChartInstance.destroy();
                    progressChartInstance = null;
                }
                return;
            }

            statsEmpty.classList.add('hidden');
            statsContent.classList.remove('hidden');

            const chronological = historyCache.slice().reverse();
            const labels = chronological.map(entry => `${entry.programTitle || entry.programId} W${entry.week}`);
            const dataPoints = chronological.map(entry => Object.keys(entry.summary || {}).length);

            if (progressChartInstance) {
                progressChartInstance.data.labels = labels;
                progressChartInstance.data.datasets[0].data = dataPoints;
                progressChartInstance.update();
            } else if (progressChartCanvas) {
                const ctx = progressChartCanvas.getContext('2d');
                progressChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: 'Notes Logged per Week',
                                data: dataPoints,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59,130,246,0.15)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.35,
                                pointRadius: 4,
                                pointBackgroundColor: '#60a5fa'
                            }
                        ]
                    },
                    options: {
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#d1d5db'
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#9ca3af'
                                },
                                grid: {
                                    color: 'rgba(55,65,81,0.3)'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#9ca3af',
                                    precision: 0
                                },
                                grid: {
                                    color: 'rgba(55,65,81,0.3)'
                                }
                            }
                        }
                    }
                });
            }

            const totalWeeks = historyCache.length;
            const historyNotes = historyCache.reduce((sum, entry) => sum + Object.keys(entry.summary || {}).length, 0);
            const programSet = new Set(historyCache.map(entry => entry.programId));
            Object.keys(notesCache || {}).forEach(programId => {
                programSet.add(programId);
            });

            statsWeeks.textContent = String(totalWeeks);
            statsNotes.textContent = String(historyNotes + currentNotes);
            statsPrograms.textContent = String(programSet.size);

            const recentEntries = historyCache.slice(0, 6);
            statsHistoryContainer.innerHTML = '';
            recentEntries.forEach(entry => {
                const wrap = document.createElement('div');
                wrap.className = 'bg-gray-800 border border-gray-700 rounded-xl p-3';
                const date = new Date(entry.timestamp).toLocaleString();
                const notes = Object.entries(entry.summary || {});
                wrap.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-semibold text-white">${entry.programTitle || entry.programId} – Week ${entry.week}</p>
                            <p class="text-xs text-gray-400">${date}</p>
                        </div>
                        <span class="text-xs text-blue-300">${notes.length} notes</span>
                    </div>
                    <ul class="mt-3 space-y-1 text-xs text-gray-300">
                        ${notes.map(([day, note]) => `<li><span class="text-blue-300 font-medium">Day ${day}:</span> ${note}</li>`).join('')}
                    </ul>
                `;
                statsHistoryContainer.appendChild(wrap);
            });
        }

        function showStatsOverlay() {
            statsOverlay.classList.add('active');
            renderStatsView();
        }

        function hideStatsOverlay() {
            statsOverlay.classList.remove('active');
        }

        function applyImportedData(payload) {
            if (!payload || typeof payload !== 'object') {
                throw new Error('Invalid backup');
            }

            if (payload.notes && typeof payload.notes === 'object') {
                saveNotes(payload.notes);
            } else {
                saveNotes({});
            }

            if (payload.history && Array.isArray(payload.history)) {
                saveHistory(payload.history);
            } else {
                saveHistory([]);
            }

            if (payload.progress) {
                saveProgress(payload.progress);
            } else {
                localStorage.removeItem(PROGRESS_KEY);
            }

            notesCache = loadNotes();
            historyCache = loadHistory();
            updateContinueCard();
            renderStatsView();
            showMessage('Backup imported');
        }

        function handleImportFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const payload = JSON.parse(event.target.result);
                        applyImportedData(payload);
                        resolve();
                    } catch (err) {
                        console.error('Failed to import backup', err);
                        showMessage('Import failed');
                        reject(err);
                    }
                };
                reader.onerror = err => {
                    console.error('Failed to read file', err);
                    showMessage('Import failed');
                    reject(err);
                };
                reader.readAsText(file);
            });
        }

        function saveProgress(data) {
            try {
                localStorage.setItem(PROGRESS_KEY, JSON.stringify(data));
            } catch (err) {
                console.error('Failed to save progress', err);
            }
        }

        function clearProgress() {
            localStorage.removeItem(PROGRESS_KEY);
            updateContinueCard();
        }

        function updateContinueCard() {
            const progress = loadProgress();
            if (!progress) {
                continueCard.classList.add('hidden');
                return;
            }
            const program = programs[progress.programId];
            if (!program) {
                continueCard.classList.add('hidden');
                return;
            }
            let trainerId = progress.trainerId || findTrainerForProgram(progress.programId);
            if (!progress.trainerId && trainerId) {
                const updated = { ...progress, trainerId };
                saveProgress(updated);
                progress.trainerId = trainerId;
            }
            const trainerName = trainerId && trainers[trainerId] ? trainers[trainerId].name : '';
            continueCard.classList.remove('hidden');
            const headline = trainerName ? `${trainerName} – Week ${progress.week}, Day ${progress.day}` : `${program.title} – Week ${progress.week}, Day ${progress.day}`;
            continueTitle.textContent = headline;
            continueSubtitle.textContent = `${program.title} · ${progress.dayTitle}`;
            continueBtn.dataset.program = progress.programId;
            continueBtn.dataset.week = progress.week;
            continueBtn.dataset.day = progress.day;
            continueBtn.dataset.trainer = trainerId || '';
        }

        function resumeProgress(programId, weekNumber, dayNumber) {
            const trainerId = findTrainerForProgram(programId);
            if (trainerId) {
                currentTrainer = trainerId;
            }
            showProgram(programId);
            showWeek(programId, weekNumber);
            showDay(programId, weekNumber, dayNumber);
            searchOverlay.classList.remove('active');
        }

        function logWeekCompletion(programId, weekNumber, summary) {
            const trainerId = findTrainerForProgram(programId);
            const entry = {
                id: `${programId}-${weekNumber}-${Date.now()}`,
                timestamp: Date.now(),
                programId,
                programTitle: programs[programId]?.title || programId,
                trainerId,
                trainerName: trainerId && trainers[trainerId] ? trainers[trainerId].name : '',
                week: weekNumber,
                summary
            };
            historyCache.unshift(entry);
            if (historyCache.length > 100) {
                historyCache = historyCache.slice(0, 100);
            }
            saveHistory(historyCache);
            if (statsOverlay.classList.contains('active')) {
                renderStatsView();
            }
        }

        function formatCardioSummary(days) {
            const cardioLines = days
                .map(day => day.cardio)
                .filter(Boolean);
            if (!cardioLines.length) return 'No cardio logged this week.';
            const uniqueLines = Array.from(new Set(cardioLines));
            return uniqueLines.join('\n');
        }

        function showSummaryModal(programId, weekNumber, weekNotes) {
            const program = programs[programId];
            if (!program) return;
            const weekData = program.weeks.find(w => w.week === weekNumber);
            if (!weekData) return;

            summaryTitle.textContent = `${program.title} – Week ${weekNumber}`;
            const cardioSummary = formatCardioSummary(weekData.days);
            summaryCardio.innerHTML = cardioSummary.replace(/\n/g, '<br>');
            summaryTask.textContent = weekData.task || 'No weekly task logged.';

            summaryNotes.innerHTML = '';
            const noteEntries = Object.entries(weekNotes || {});
            if (noteEntries.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'No notes entered this week.';
                summaryNotes.appendChild(li);
            } else {
                noteEntries.sort((a, b) => Number(a[0]) - Number(b[0]));
                noteEntries.forEach(([day, note]) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="text-blue-300">Day ${day}:</span> ${note}`;
                    summaryNotes.appendChild(li);
                });
            }

            summaryHistory.innerHTML = '';
            const matchingHistory = historyCache.filter(entry => entry.programId === programId && entry.week === weekNumber);
            if (!matchingHistory.length) {
                const p = document.createElement('p');
                p.className = 'text-gray-400';
                p.textContent = 'No previous runs yet. Complete this week to start building your timeline.';
                summaryHistory.appendChild(p);
            } else {
                matchingHistory.forEach(entry => {
                    const wrap = document.createElement('div');
                    const date = new Date(entry.timestamp).toLocaleString();
                    wrap.innerHTML = `
                        <p class="text-xs text-gray-500">${date}</p>
                        <ul class="text-sm text-gray-300 space-y-1">
                            ${Object.entries(entry.summary).map(([day, note]) => `<li><span class="text-blue-300">Day ${day}:</span> ${note}</li>`).join('')}
                        </ul>
                    `;
                    summaryHistory.appendChild(wrap);
                });
            }

            summaryOverlay.classList.remove('hidden');
        }

        function hideSummaryModal() {
            summaryOverlay.classList.add('hidden');
            if (pendingNavigation && pendingNavigation.type === 'week') {
                showWeek(pendingNavigation.program, pendingNavigation.week);
            }
            pendingNavigation = null;
        }

        function buildSearchIndex() {
            searchIndex = [];
            Object.entries(programs).forEach(([programId, program]) => {
                if (!program || !Array.isArray(program.weeks)) {
                    return;
                }
                program.weeks.forEach(week => {
                    week.days.forEach(day => {
                        const trainerId = findTrainerForProgram(programId);
                        const trainerName = trainerId && trainers[trainerId] ? trainers[trainerId].name : '';
                        day.exercises.forEach(exercise => {
                            searchIndex.push({
                                programId,
                                programTitle: program.title,
                                trainerName,
                                week: week.week,
                                weekTask: week.task,
                                day: day.day,
                                dayTitle: day.title,
                                cardio: day.cardio,
                                exerciseName: exercise.name,
                                notes: exercise.notes
                            });
                        });
                    });
                });
            });
        }

        function renderSearchResults(query) {
            const normalized = query.trim().toLowerCase();
            searchResults.innerHTML = '';
            if (!normalized) {
                return;
            }
            const results = searchIndex.filter(item => item.exerciseName.toLowerCase().includes(normalized)).slice(0, 30);
            if (results.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'text-gray-400';
                empty.textContent = 'No exercises found. Try another keyword.';
                searchResults.appendChild(empty);
                return;
            }
            results.forEach(item => {
                const card = document.createElement('button');
                card.className = 'search-result w-full text-left p-4 rounded-xl bg-gray-800 hover:bg-gray-750';
                const header = item.trainerName ? `${item.trainerName} · ${item.programTitle}` : item.programTitle;
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm uppercase tracking-wider text-blue-300">${header}</p>
                            <p class="text-lg font-semibold text-white">${item.exerciseName}</p>
                            <p class="text-sm text-gray-300">Week ${item.week}, Day ${item.day} – ${item.dayTitle}</p>
                            ${item.notes ? `<p class="text-xs text-gray-400 mt-1">${item.notes}</p>` : ''}
                        </div>
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                `;
                card.onclick = () => {
                    resumeProgress(item.programId, item.week, item.day);
                };
                searchResults.appendChild(card);
            });
        }

        function findTrainerForProgram(programId) {
            return Object.keys(trainers).find(trainerId =>
                trainers[trainerId].programs.some(program => program.id === programId)
            ) || '';
        }

        function formatThenxTag(tag) {
            return tag.split(' ').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join(' ');
        }

        function renderThenxFocusFilters() {
            if (!thenxFocusChipContainer) return;
            if (thenxFilterState.focus === 'favorites' && thenxFavorites.size === 0) {
                thenxFilterState.focus = 'all';
            }
            const hasFavorites = thenxFavorites.size > 0;
            const options = ['all'];
            if (hasFavorites || thenxFilterState.focus === 'favorites') {
                options.push('favorites');
            }
            options.push(...thenxFocusOptions);
            thenxFocusChipContainer.innerHTML = '';
            options.forEach(option => {
                const button = document.createElement('button');
                const isActive = thenxFilterState.focus === option;
                const isDisabled = option === 'favorites' && thenxFavorites.size === 0;
                button.className = `btn-press px-3 py-1 rounded-full text-xs font-semibold border ${isActive ? 'bg-blue-600 text-white border-blue-500' : 'bg-gray-800 border-gray-700 text-gray-300 hover:border-blue-500'} ${isDisabled ? 'opacity-50 pointer-events-none' : ''}`;
                if (option === 'favorites') {
                    button.innerHTML = '★ Favorites';
                } else {
                    button.textContent = option === 'all' ? 'All' : formatThenxTag(option);
                }
                button.addEventListener('click', () => {
                    if (thenxFilterState.focus === option || isDisabled) return;
                    thenxFilterState.focus = option;
                    renderThenxFocusFilters();
                    if (programs.thenxLibrary) {
                        renderThenxLibraryList(programs.thenxLibrary);
                    }
                });
                thenxFocusChipContainer.appendChild(button);
            });
        }

        function renderThenxLibraryList(program) {
            if (!thenxWorkoutList || !program) return;
            const workouts = Array.isArray(program.workouts) ? program.workouts : [];
            const focusFilter = thenxFilterState.focus;
            const filtered = workouts.filter(workout => {
                const focusLower = workout.focusLower || [];
                if (focusFilter === 'favorites') {
                    if (!thenxFavorites.has(workout.url)) {
                        return false;
                    }
                } else if (focusFilter !== 'all' && !focusLower.includes(focusFilter)) {
                    return false;
                }
                if (thenxFilterState.search) {
                    const haystack = workout.searchHaystack || '';
                    if (!haystack.includes(thenxFilterState.search)) {
                        return false;
                    }
                }
                return true;
            });

            thenxWorkoutList.innerHTML = '';
            if (!filtered.length) {
                if (thenxLibraryEmpty) thenxLibraryEmpty.classList.remove('hidden');
            } else {
                if (thenxLibraryEmpty) thenxLibraryEmpty.classList.add('hidden');
                const fragment = document.createDocumentFragment();
                filtered.slice(0, THENX_SEARCH_LIMIT).forEach(workout => {
                    const isFavorite = thenxFavorites.has(workout.url);
                    const card = document.createElement('a');
                    card.href = workout.url;
                    card.target = '_blank';
                    card.rel = 'noopener noreferrer';
                    card.className = 'block bg-gray-900 border border-gray-700 rounded-2xl overflow-hidden relative transition hover:border-blue-500';
                    const focusBadges = (workout.focus || []).map(tag => `<span class="px-2 py-1 rounded-full bg-gray-900/80 border border-gray-700 text-xs text-gray-200">${formatThenxTag(tag)}</span>`).join('');
                    const backgroundStyle = workout.image ? `background-image: url('${workout.image}'); background-size: cover; background-position: center;` : '';
                    card.innerHTML = `
                        <div class="relative h-40 ${workout.image ? '' : 'bg-gray-800'}" ${backgroundStyle ? `style="${backgroundStyle}"` : ''}>
                            <div class="absolute inset-0 bg-gradient-to-t from-gray-900/90 via-gray-900/30 to-transparent"></div>
                            <div class="absolute top-3 left-3 flex flex-wrap gap-2">${focusBadges}</div>
                            ${workout.date ? `<div class="absolute bottom-3 left-3"><p class="text-xs text-gray-200">${workout.date}</p></div>` : ''}
                        </div>
                        <div class="p-4 space-y-3">
                            <p class="text-lg font-semibold text-white">${workout.title}</p>
                            <div class="flex items-center gap-4 text-xs text-gray-400">
                                <span>❤️ ${workout.likes ?? '—'}</span>
                                <span>💬 ${workout.comments ?? '—'}</span>
                                ${workout.level && workout.level !== 'all' ? `<span class="capitalize">${workout.level}</span>` : ''}
                            </div>
                            <p class="text-sm text-blue-300">Open on ThenX &rarr;</p>
                        </div>
                    `;
                    const favoriteButton = document.createElement('button');
                    favoriteButton.type = 'button';
                    favoriteButton.className = `absolute top-3 right-3 text-lg ${isFavorite ? 'text-yellow-300' : 'text-gray-300 hover:text-yellow-200'} bg-gray-900/70 backdrop-blur px-2 py-1 rounded-full`;
                    favoriteButton.innerHTML = isFavorite ? '★ Fav' : '☆ Fav';
                    favoriteButton.addEventListener('click', (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        toggleThenxFavorite(workout.url, program);
                    });
                    card.appendChild(favoriteButton);
                    fragment.appendChild(card);
                });
                thenxWorkoutList.appendChild(fragment);
            }

            if (thenxLibrarySummary) {
                const total = workouts.length;
                const focusLabel = focusFilter === 'all' ? 'All focuses' : focusFilter === 'favorites' ? 'Favorites' : formatThenxTag(focusFilter);
                const updatedLabel = program.updatedAt ? `Updated ${new Date(program.updatedAt).toLocaleDateString()}` : 'Latest refresh';
                const favoritesLabel = thenxFavorites.size ? ` · Favorites saved: ${thenxFavorites.size}` : '';
                const displayedCount = Math.min(filtered.length, THENX_SEARCH_LIMIT);
                const limitedLabel = filtered.length > THENX_SEARCH_LIMIT ? ` (showing top ${THENX_SEARCH_LIMIT})` : '';
                thenxLibrarySummary.textContent = `${displayedCount} of ${total} workouts${limitedLabel} · ${focusLabel} · ${updatedLabel}${favoritesLabel}`;
            }
        }

        function renderThenxLibrary(program) {
            if (!program || !Array.isArray(program.workouts)) {
                showMessage('ThenX workouts are not available yet.');
                return;
            }
            if (thenxLibraryTitle) {
                thenxLibraryTitle.textContent = program.title;
            }
            thenxFilterState = { focus: 'all', search: '' };
            if (thenxSearchInput) {
                thenxSearchInput.value = '';
            }
            renderThenxFocusFilters();
            renderThenxLibraryList(program);
        }

        function renderTrainerCards() {
            if (!trainerCardContainer) return;
            trainerCardContainer.innerHTML = '';
            Object.entries(trainers).forEach(([trainerId, trainer]) => {
                const button = document.createElement('button');
                button.className = 'trainer-card btn-press w-full rounded-2xl shadow-lg border border-gray-700';
                const programSummary = trainer.programs
                    .map(programRef => programRef.subtitle || (programs[programRef.id]?.title ?? ''))
                    .filter(Boolean)
                    .join(' | ');
                const position = trainer.imagePosition || '';
                const bgStyle = trainer.image
                    ? `style="background-image: url('${trainer.image}');${position ? ` background-position: ${position};` : ''}"`
                    : '';
                button.innerHTML = `
                    <div class="trainer-card-bg" ${bgStyle}></div>
                    <div class="trainer-card-shade"></div>
                    <div class="trainer-card-content relative z-10 flex items-center justify-between w-full p-6">
                        <div class="text-left">
                            <p class="text-lg font-semibold text-white">${trainer.name}</p>
                            ${programSummary ? `<p class="text-sm text-gray-200">${programSummary}</p>` : ''}
                        </div>
                        <svg class="w-5 h-5 text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                `;
                button.classList.add('card-await');
                button.dataset.cardAnimated = 'false';
                button.addEventListener('click', () => {
                    showTrainer(trainerId);
                });
                trainerCardContainer.appendChild(button);
            });
            startTrainerCardEntrance();
        }

        function startTrainerCardEntrance() {
            if (!trainerCardContainer) return;
            if (splashOverlay && splashOverlay.parentElement && !splashOverlay.classList.contains('is-hidden')) {
                return;
            }
            const pendingCards = Array.from(trainerCardContainer.querySelectorAll('.trainer-card'))
                .filter(card => card.dataset.cardAnimated !== 'true');
            if (!pendingCards.length) return;

            pendingCards.forEach((card, index) => {
                card.dataset.cardAnimated = 'true';
                card.style.setProperty('--card-delay', `${index * 0.09}s`);
                card.classList.add('card-fly-in');
                card.addEventListener('animationend', () => {
                    card.classList.remove('card-fly-in');
                    card.classList.remove('card-await');
                }, { once: true });
            });
        }

        function setSplashCardTransform(card, angleDeg, fanRadius) {
            const radians = (angleDeg - 90) * (Math.PI / 180);
            const fanX = Math.cos(radians) * fanRadius;
            const fanY = Math.sin(radians) * fanRadius;
            card.style.setProperty('--fan-x', `${fanX.toFixed(2)}px`);
            card.style.setProperty('--fan-y', `${fanY.toFixed(2)}px`);
            card.style.setProperty('--fan-tilt', `0deg`);
            card.style.setProperty('--entry-tilt', `0deg`);
        }

        function initSplashSequence() {
            if (!splashOverlay || !splashCarousel || !splashCardsContainer) {
                startTrainerCardEntrance();
                return;
            }

            const splashItems = [];
            const seen = new Set();
            Object.entries(trainers).forEach(([trainerId, trainer]) => {
                if (trainer.image && !seen.has(`trainer:${trainerId}`)) {
                    splashItems.push({
                        label: trainer.name,
                        image: trainer.image
                    });
                    seen.add(`trainer:${trainerId}`);
                }
                if (Array.isArray(trainer.programs)) {
                    trainer.programs.forEach(programRef => {
                        const programId = programRef.id;
                        if (!programId) return;
                        const splashId = `program:${programId}`;
                        if (seen.has(splashId)) return;
                        const programData = programs[programId];
                        const programLabel = programRef.subtitle || programData?.title || trainer.name;
                        const programImage = programRef.image || programData?.image;
                        if (programImage) {
                            splashItems.push({
                                label: programLabel,
                                image: programImage
                            });
                            seen.add(splashId);
                        }
                    });
                }
            });

            while (splashItems.length > 0 && splashItems.length < 4) {
                splashItems.push({ ...splashItems[splashItems.length % splashItems.length] });
            }

            if (!splashItems.length) {
                splashOverlay.classList.add('is-hidden');
                setTimeout(() => {
                    if (splashOverlay.parentElement) splashOverlay.remove();
                    startTrainerCardEntrance();
                }, 250);
                return;
            }

            splashCardsContainer.innerHTML = '';
            const viewportMin = Math.min(window.innerWidth, window.innerHeight);
            let baseRadius = Math.max(120, Math.min(viewportMin * 0.23, 210));
            const desiredSize = baseRadius * 2 + 180;
            const maxSize = viewportMin * 0.9;
            const finalSize = Math.min(desiredSize, maxSize);
            splashCarousel.style.width = `${finalSize}px`;
            splashCarousel.style.height = `${finalSize}px`;
            const fanRadius = Math.max(90, Math.min(baseRadius, finalSize / 2 - 60));

            const splashMeta = [];
            splashItems.forEach((item, index) => {
                const angle = (360 / splashItems.length) * index;
                const card = document.createElement('div');
                card.className = 'splash-card';
                const backgroundStyle = item.image ? `style="background-image: url('${item.image}')"` : '';
                card.innerHTML = `
                    <div class="splash-card-inner">
                        <div class="splash-card-bg" ${backgroundStyle}></div>
                        <div class="splash-card-overlay">
                            <span class="splash-card-name">${item.label || ''}</span>
                        </div>
                    </div>
                `;
                splashCardsContainer.appendChild(card);
                setSplashCardTransform(card, angle, fanRadius);
                card.style.opacity = '0';
                card.style.visibility = 'hidden';
                splashMeta.push({ card, angle });
            });

            requestAnimationFrame(() => {
                splashCarousel.classList.add('ready');
                splashMeta.forEach(({ card }, idx) => {
                    const delay = idx * 90;
                    setTimeout(() => {
                        card.style.visibility = 'visible';
                        card.style.opacity = '1';
                        card.classList.add('burst-enter');
                        setTimeout(() => {
                            card.classList.add('burst-fanned');
                        }, 70);
                    }, delay);
                });
            });

            let splashFinished = false;
            let holdTimer = null;
            let skipHandler = null;

            const finishSplash = () => {
                if (splashFinished) return;
                splashFinished = true;
                if (holdTimer) clearTimeout(holdTimer);
                if (skipHandler) {
                    splashOverlay.removeEventListener('click', skipHandler);
                    splashOverlay.removeEventListener('touchstart', skipHandler);
                }

                const collapseOrder = [...splashMeta].reverse();
                collapseOrder.forEach(({ card }, idx) => {
                    setTimeout(() => {
                        card.classList.remove('burst-fanned');
                        setTimeout(() => {
                            card.classList.add('fan-exit');
                        }, 100);
                    }, idx * 55);
                });

                const collapseDuration = (collapseOrder.length - 1) * 55 + 400;
                setTimeout(() => {
                    splashOverlay.classList.add('is-hidden');
                    setTimeout(() => {
                        if (splashOverlay.parentElement) {
                            splashOverlay.remove();
                        }
                        startTrainerCardEntrance();
                    }, 240);
                }, collapseDuration);
            };

            const totalFanTime = (splashMeta.length - 1) * 90 + 40;
            const holdDuration = 420;
            holdTimer = setTimeout(() => {
                finishSplash();
            }, totalFanTime + holdDuration);

            skipHandler = () => finishSplash();
            splashOverlay.addEventListener('click', skipHandler, { once: true });
            splashOverlay.addEventListener('touchstart', skipHandler, { once: true });
        }

        function showTrainer(trainerId) {
            const trainer = trainers[trainerId];
            if (!trainer) {
                showMessage('Trainer not found.');
                return;
            }
            currentTrainer = trainerId;
            if (trainerTitle) {
                trainerTitle.textContent = trainer.name;
            }
            if (trainerProgramList) {
                trainerProgramList.innerHTML = '';
                trainer.programs.forEach(programRef => {
                    const programData = programs[programRef.id];
                    if (!programData) {
                        return;
                    }
                    const isLibrary = programData.type === 'library';
                    const weeksCount = Array.isArray(programData.weeks) ? programData.weeks.length : 0;
                    const workoutsCount = isLibrary && Array.isArray(programData.workouts) ? programData.workouts.length : 0;
                    if (!isLibrary && weeksCount === 0) {
                        return;
                    }
                    const detailLabel = isLibrary
                        ? `${workoutsCount} workout${workoutsCount === 1 ? '' : 's'}`
                        : `${weeksCount} week${weeksCount === 1 ? '' : 's'}`;
                    const button = document.createElement('button');
                    button.className = 'trainer-card btn-press w-full rounded-2xl shadow-lg border border-gray-700 overflow-hidden';
                    const subtitle = programRef.subtitle && programRef.subtitle !== programData.title ? programRef.subtitle : '';
                    const imagePosition = programRef.imagePosition || '';
                    const bgStyle = programRef.image
                        ? `style="background-image: url('${programRef.image}');${imagePosition ? ` background-position: ${imagePosition};` : ''}"`
                        : '';
                    button.innerHTML = `
                        <div class="trainer-card-bg" ${bgStyle}></div>
                        <div class="trainer-card-shade"></div>
                        <div class="trainer-card-content relative z-10 flex items-center justify-between w-full p-6">
                            <div class="text-left space-y-1">
                                <p class="text-lg font-semibold text-white">${programData.title}</p>
                                ${subtitle ? `<p class="text-sm text-gray-200">${subtitle}</p>` : ''}
                                <p class="text-xs text-gray-400 uppercase tracking-wider">${detailLabel}</p>
                            </div>
                            <svg class="w-5 h-5 text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </div>
                    `;
                    button.addEventListener('click', () => {
                        showProgram(programRef.id);
                    });
                    trainerProgramList.appendChild(button);
                });
            }
            showPage('page-trainer-programs');
        }

        function goToTrainerPage() {
            if (currentTrainer && trainers[currentTrainer]) {
                showTrainer(currentTrainer);
            } else {
                showPage('page-main-menu');
            }
        }

        // --- PAGE NAVIGATION & STATE ---
        let currentTrainer = '';
        let currentPage = '';
        let currentProgram = '';
        let currentWeek = 0;
        let currentDay = 0;

        function showPage(pageId) {
            if (currentPage === pageId) {
                return;
            }

            const currentPageElement = document.getElementById(currentPage);
            if (currentPageElement) {
                currentPageElement.classList.remove('entered');
                currentPageElement.classList.add('leaving');
                setTimeout(() => {
                    currentPageElement.classList.remove('active', 'leaving');
                }, 250);
            }
            
            const nextPageElement = document.getElementById(pageId);
            if (!nextPageElement) {
                console.error("Page not found:", pageId);
                return;
            }

            nextPageElement.classList.add('active', 'entering');
            requestAnimationFrame(() => {
                nextPageElement.classList.remove('entering');
                nextPageElement.classList.add('entered');
            });
            
            currentPage = pageId;

            // Scroll to top of new page's content
            const content = nextPageElement.querySelector('.page-content');
            if (content) {
                content.scrollTo(0, 0);
            }
        }

        // --- APP LOGIC ---

        // (Step 1) Show list of Weeks for a Program
        function showProgram(programName) {
            currentProgram = programName;
            const program = programs[programName];
            if (!program) {
                showMessage(`Program ${programName} not found.`);
                return;
            }

            const derivedTrainer = findTrainerForProgram(programName);
            if (!currentTrainer || !trainers[currentTrainer] || !trainers[currentTrainer].programs.some(p => p.id === programName)) {
                currentTrainer = derivedTrainer;
            }

            const programTitleEl = document.getElementById('program-title');
            if (programTitleEl) {
                programTitleEl.textContent = program.title;
            }

            if (program.type === 'library') {
                currentWeek = 0;
                currentDay = 0;
                renderThenxLibrary(program);
                showPage('page-thenx-library');
                return;
            }

            if (!program.weeks || !program.weeks.length) {
                showMessage(`Program data for ${program.title} is not loaded yet.`);
                return;
            }

                 document.getElementById('program-title').textContent = program.title;
                 const weekList = document.getElementById('week-list');
                 weekList.innerHTML = '';
                 
            const orderedWeeks = [...program.weeks].sort((a, b) => a.week - b.week);
            orderedWeeks.forEach(week => {
                    const weekButton = document.createElement('button');
                    weekButton.className = 'btn-press w-full text-left p-5 bg-gray-800 rounded-lg border border-gray-700 shadow-md flex justify-between items-center';
                weekButton.innerHTML = `
                    <span class="text-lg font-semibold text-white">Week ${week.week}</span>
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                `;
                weekButton.addEventListener('click', () => showWeek(programName, week.week));
                weekList.appendChild(weekButton);
            });

            showPage('page-program-weeks');
        }

        function renderThenxLibrary(program) {
            const trainerProgramList = document.getElementById('trainer-program-list');
            if (!trainerProgramList) return;

            trainerProgramList.innerHTML = '';
            program.workouts.forEach(workout => {
                const workoutButton = document.createElement('button');
                workoutButton.className = 'trainer-card btn-press w-full rounded-2xl shadow-lg border border-gray-700 overflow-hidden';
                workoutButton.innerHTML = `
                    <div class="trainer-card-bg" style="background-image: url('${workout.image || ''}'); background-position: center center;"></div>
                    <div class="trainer-card-shade"></div>
                    <div class="trainer-card-content relative z-10 flex items-center justify-between w-full p-6">
                        <div class="text-left space-y-1">
                            <p class="text-lg font-semibold text-white">${workout.name}</p>
                            <p class="text-sm text-gray-200">${workout.description || ''}</p>
                            <p class="text-xs text-gray-400 uppercase tracking-wider">${workout.level || 'All Levels'}</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                `;
                workoutButton.addEventListener('click', () => {
                    showDay(program.id, 1, 1); // Assuming a default week/day for library workouts
                });
                trainerProgramList.appendChild(workoutButton);
            });
        }

        // (Step 2) Show list of Days for a Week
        function showWeek(programName, weekNumber) {
            currentWeek = weekNumber;
            const program = programs[programName];
            const week = program.weeks.find(w => w.week === weekNumber);

            if (!week) {
                showMessage(`Workout data for Week ${weekNumber} is not loaded.`);
                return;
            }

            document.getElementById('week-title').textContent = `Week ${weekNumber}`;
            const dayList = document.getElementById('day-list');
            dayList.innerHTML = ''; // Clear old list

            week.days.forEach(day => {
                const dayButton = document.createElement('button');
                dayButton.className = 'btn-press w-full text-left p-5 bg-gray-800 rounded-lg border border-gray-700 shadow-md';
                dayButton.onclick = () => showDay(programName, weekNumber, day.day);

                dayButton.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-sm text-blue-400 font-semibold">Day ${day.day}</span>
                            <p class="text-lg font-semibold text-white">${day.title}</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                `;
                dayList.appendChild(dayButton);
            });
            
            showPage('page-week-days');
        }

        // (Step 3) Show the Workout for a specific Day
        function showDay(programName, weekNumber, dayNumber) {
            currentDay = dayNumber;
            const program = programs[programName];
            const week = program.weeks.find(w => w.week === weekNumber);
            const day = week.days.find(d => d.day === dayNumber);

            const cardioText = day.cardio && day.cardio.trim() ? day.cardio : "See program guidance for cardio.";
            const weeklyTaskText = week.task && week.task.trim() ? week.task : "See program guidance for this week's focus.";

            document.getElementById('day-title').textContent = `Day ${dayNumber}: ${day.title}`;
            
            const workoutContent = document.getElementById('workout-content');
            workoutContent.innerHTML = ''; // Clear old content

            // 1. Add Cardio
            workoutContent.innerHTML += `
                <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                    <h2 class="text-xl font-bold text-white mb-2">Cardio</h2>
                    <p class="text-lg text-gray-300">${cardioText}</p>
                </div>
            `;
            
            // 2. Add Weekly Task
            workoutContent.innerHTML += `
                <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
                    <div class="overflow-hidden">
                        <button class="collapsible-trigger w-full flex items-center justify-between px-4 py-3 text-left focus:outline-none" aria-expanded="true">
                            <div>
                                <h2 class="text-xl font-bold text-white">Weekly Task</h2>
                                <p class="text-xs text-gray-400">Tap to collapse or expand</p>
                            </div>
                            <svg class="w-4 h-4 text-gray-400 icon-rotate" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                        <div class="collapsible-card expanded">
                            <div class="p-4 pt-0">
                                <p class="text-lg text-gray-300">${weeklyTaskText}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            if (day.video) {
                const videoCard = document.createElement('div');
                videoCard.className = 'bg-gray-800 rounded-lg border border-gray-700 shadow-lg overflow-hidden';
                videoCard.innerHTML = `
                    <div class="overflow-hidden">
                        <button class="collapsible-trigger w-full flex items-center justify-between px-4 py-3 text-left focus:outline-none" aria-expanded="false">
                            <div>
                                <h2 class="text-xl font-bold text-white">Daily Video</h2>
                                <p class="text-xs text-gray-400">Tap to view walkthrough</p>
                            </div>
                            <svg class="w-4 h-4 text-gray-400 icon-rotate" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                        <div class="collapsible-card">
                            <div class="relative" style="padding-top: 56.25%;">
                                <iframe src="${day.video}" title="Workout video" loading="lazy" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen class="absolute inset-0 w-full h-full border-none"></iframe>
                            </div>
                        </div>
                    </div>
                `;
                workoutContent.appendChild(videoCard);
            }

            if (Array.isArray(day.notes) && day.notes.length) {
                const coachCard = document.createElement('div');
                coachCard.className = 'bg-gray-800 rounded-lg border border-gray-700 shadow-lg overflow-hidden';
                const triggerId = `coach-notes-${weekNumber}-${dayNumber}`;
                coachCard.innerHTML = `
                    <div class="overflow-hidden">
                        <button class="collapsible-trigger w-full flex items-center justify-between px-4 py-3 text-left focus:outline-none" aria-expanded="true" aria-controls="${triggerId}">
                            <div>
                                <h2 class="text-xl font-bold text-white">Coach Notes</h2>
                                <p class="text-xs text-gray-400">Tap to collapse or expand</p>
                            </div>
                            <svg class="w-4 h-4 text-gray-400 icon-rotate" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                        <div id="${triggerId}" class="collapsible-card expanded">
                            <div class="p-4 space-y-3">
                                ${day.notes.map(noteText => `<p class="text-sm text-gray-300 leading-relaxed">${noteText}</p>`).join('')}
                                ${day.url ? `<a href="${day.url}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-sm text-blue-300 hover:text-blue-100">View full article →</a>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                workoutContent.appendChild(coachCard);
            }

            if (Array.isArray(day.exercises) && day.exercises.length) {
                const workoutCard = document.createElement('div');
                workoutCard.className = 'bg-gray-800 rounded-lg border border-gray-700 shadow-lg overflow-hidden';
                const workoutPanelId = `workout-plan-${weekNumber}-${dayNumber}`;
                workoutCard.innerHTML = `
                    <div class="overflow-hidden">
                        <button class="collapsible-trigger w-full flex items-center justify-between px-4 py-3 text-left focus:outline-none" aria-expanded="true" aria-controls="${workoutPanelId}">
                            <div>
                                <h2 class="text-xl font-bold text-white">Workout Plan</h2>
                                <p class="text-xs text-gray-400">Tap to collapse or expand</p>
                            </div>
                            <svg class="w-4 h-4 text-gray-400 icon-rotate" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                        <div id="${workoutPanelId}" class="collapsible-card expanded">
                            <div class="divide-y divide-gray-800"></div>
                        </div>
                    </div>
                `;

                const exerciseList = workoutCard.querySelector('.divide-y');

                if (exerciseList) {
                    let exerciseCounter = 0;

                    const createExerciseRow = (exercise, indexLabel, options = {}) => {
                        const item = document.createElement('div');
                        item.className = options.compact
                            ? 'rounded-xl border border-gray-800/70 bg-gray-900/70 p-4 space-y-3'
                            : 'p-4 space-y-3';

                        const topRow = document.createElement('div');
                        topRow.className = 'flex flex-col gap-3 sm:flex-row sm:items-baseline sm:justify-between';

                        const titleWrap = document.createElement('div');
                        titleWrap.className = 'flex items-baseline gap-3 flex-wrap';

                        const indexTag = document.createElement('span');
                        indexTag.className = 'text-xs font-semibold uppercase tracking-widest text-blue-400';
                        indexTag.textContent = indexLabel;
                        titleWrap.appendChild(indexTag);

                        const nameEl = document.createElement('p');
                        nameEl.className = options.compact ? 'text-base font-semibold text-white' : 'text-lg font-semibold text-white';
                        const rawName = exercise.name || `Exercise ${indexLabel.replace('#', '')}`;
                        const displayName = options.stripPrefix
                            ? rawName.replace(/^\d+[A-Za-z]+[\.\-\):]*\s*/, '').replace(/^\d+[\.\-\):]*\s*/, '')
                            : rawName;
                        nameEl.textContent = displayName;
                        titleWrap.appendChild(nameEl);

                        if (exercise.section && exercise.section.trim()) {
                            const sectionTag = document.createElement('span');
                            sectionTag.className = 'px-2 py-1 rounded-full border border-gray-800 text-[0.6rem] uppercase tracking-[0.25em] text-gray-500';
                            sectionTag.textContent = exercise.section;
                            titleWrap.appendChild(sectionTag);
                        }

                        topRow.appendChild(titleWrap);

                        const metrics = [];
                        if (exercise.sets) metrics.push({ label: 'Sets', value: exercise.sets, type: 'sets' });
                        if (exercise.reps) metrics.push({ label: 'Reps', value: exercise.reps, type: 'reps' });
                        if (exercise.rest) metrics.push({ label: 'Rest', value: exercise.rest, type: 'rest' });
                        if (metrics.length === 0 && exercise.info && exercise.info.trim()) {
                            metrics.push({ label: 'Target', value: exercise.info, type: 'info' });
                        }

                        if (metrics.length) {
                            const metricsWrap = document.createElement('div');
                            metricsWrap.className = 'flex flex-wrap items-center gap-3 text-xs uppercase tracking-wider text-gray-400 self-start sm:self-auto sm:justify-end';

                            metrics.forEach(metric => {
                                const badge = document.createElement('span');
                                badge.className = `metric-badge metric-badge--${metric.type}`;
                                badge.innerHTML = `
                                    <span class="metric-badge-dot"></span>
                                    <span class="metric-badge-label">${metric.label}</span>
                                    <span class="metric-badge-value">${metric.value}</span>
                                `;
                                metricsWrap.appendChild(badge);
                            });

                            topRow.appendChild(metricsWrap);
                        }

                        item.appendChild(topRow);

                        if (exercise.info && exercise.info.trim() && metrics.every(m => m.value !== exercise.info.trim())) {
                            const infoEl = document.createElement('p');
                            infoEl.className = 'text-sm text-blue-200/80';
                            infoEl.textContent = exercise.info.trim();
                            item.appendChild(infoEl);
                        }

                        if (exercise.notes && exercise.notes.trim()) {
                            const noteEl = document.createElement('p');
                            noteEl.className = 'text-sm text-gray-400 leading-relaxed';
                            noteEl.textContent = exercise.notes.trim();
                            item.appendChild(noteEl);
                        }

                        return item;
                    };

        const GROUP_CAPTIONS = {
            superset: 'Perform each move back-to-back before resting.',
            triple: 'Move through the trio without rest, then recover after completing all three.',
            circuit: 'Work through the circuit continuously before taking your rest.',
            giant: 'Cycle through each move in order, then repeat for the prescribed rounds.'
        };

        const normalizeExerciseName = (value = '') => value
            .toLowerCase()
            .replace(/[^a-z0-9\s]/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();

        const detectGroupType = (text = '') => {
            const lower = text.toLowerCase();
            if (!lower) return null;
            if (lower.includes('triple set')) return 'triple';
            if (lower.includes('giant set')) return 'giant';
            if (lower.includes('superset')) return 'superset';
            if (lower.includes('circuit')) return 'circuit';
            return null;
        };

        const toTitleCase = (value = '') => value
            .replace(/\s+/g, ' ')
            .trim()
            .split(' ')
            .filter(Boolean)
            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
            .join(' ');

        const buildGroupLabelFromText = (type, text = '') => {
            if (!text) return toTitleCase(type);
            const trimmed = text.trim();
            const colonIndex = trimmed.indexOf(':');
            if (colonIndex !== -1) {
                return toTitleCase(trimmed.substring(0, colonIndex));
            }
            const periodIndex = trimmed.indexOf('.');
            if (periodIndex !== -1) {
                return toTitleCase(trimmed.substring(0, periodIndex));
            }
            const match = trimmed.match(new RegExp(`${type}\\s*\\d+`, 'i'));
            if (match) {
                return toTitleCase(match[0]);
            }
            return toTitleCase(type);
        };

        const collectMembersFromText = (text = '', exercises, anchorIndex) => {
            const normalizedText = normalizeExerciseName(text);
            const members = new Set();
            if (!normalizedText) return members;

            const maxIndex = Math.min(exercises.length, anchorIndex + 12);
            for (let i = anchorIndex; i < maxIndex; i++) {
                const candidate = normalizeExerciseName(exercises[i]?.name || '');
                if (!candidate) continue;
                if (normalizedText.includes(candidate)) {
                    members.add(candidate);
                }
            }
            return members;
        };

        const ensureMembers = (type, members, exercises, anchorIndex) => {
            const fallbackCount = type === 'triple' ? 3 : type === 'circuit' ? 5 : type === 'giant' ? 3 : 2;
            if (!members.size) {
                for (let i = anchorIndex; i < Math.min(exercises.length, anchorIndex + fallbackCount); i++) {
                    const candidate = normalizeExerciseName(exercises[i]?.name || '');
                    if (candidate) {
                        members.add(candidate);
                    }
                }
            } else {
                const anchorName = normalizeExerciseName(exercises[anchorIndex]?.name || '');
                if (anchorName) {
                    members.add(anchorName);
                }
            }
            return members;
        };

        const buildMetaFromText = (type, text, sourceIndex, exercises, presetMembers = null) => {
            const label = buildGroupLabelFromText(type, text);
            const baseMembers = presetMembers ? new Set(presetMembers) : collectMembersFromText(text, exercises, sourceIndex);
            const members = ensureMembers(type, baseMembers, exercises, sourceIndex);
            return {
                key: `${type}|rest|${sourceIndex}`,
                label,
                type,
                derivedFromRest: true,
                caption: GROUP_CAPTIONS[type] || GROUP_CAPTIONS.superset,
                members
            };
        };

        const getGroupMeta = (exercise, index, exercises) => {
                        if (!exercise) return null;
                        const subsectionRaw = typeof exercise.subsection === 'string' ? exercise.subsection.trim() : '';
                        const sectionRaw = typeof exercise.section === 'string' ? exercise.section.trim() : '';
                        const nameRaw = typeof exercise.name === 'string' ? exercise.name.trim() : '';
        const restRaw = typeof exercise.rest === 'string' ? exercise.rest.trim() : '';
        const notesRaw = typeof exercise.notes === 'string' ? exercise.notes.trim() : '';

                        const buildMeta = (type, source, labelPrimary, labelSecondary = '') => {
                            const lowerPrimary = labelPrimary.toLowerCase();
                            const lowerSecondary = labelSecondary ? labelSecondary.toLowerCase() : '';
                            const key = `${type}|${source}|${lowerPrimary}|${lowerSecondary}`;
                            const label = labelSecondary ? `${labelSecondary} · ${labelPrimary}` : labelPrimary;
                            return {
                                key,
                                label,
                                type,
                        derivedFromRest: false,
                        caption: GROUP_CAPTIONS[type] || GROUP_CAPTIONS.superset,
                        members: null
                            };
                        };

                    const subsectionLower = subsectionRaw.toLowerCase();
                    const sectionLower = sectionRaw.toLowerCase();
                    const nameLower = nameRaw.toLowerCase();

                    if (subsectionLower.includes('giant set')) {
                        return buildMeta('giant', 'subsection', subsectionRaw, sectionRaw);
                    }
                    if (subsectionLower.includes('superset')) {
                        return buildMeta('superset', 'subsection', subsectionRaw, sectionRaw);
                    }
                    if (subsectionLower.includes('triple set')) {
                        return buildMeta('triple', 'subsection', subsectionRaw, sectionRaw);
                    }
                    if (subsectionLower.includes('circuit')) {
                        return buildMeta('circuit', 'subsection', subsectionRaw, sectionRaw);
                        }
                    if (sectionLower.includes('giant set')) {
                        return buildMeta('giant', 'section', sectionRaw);
                        }
                    if (sectionLower.includes('superset')) {
                        return buildMeta('superset', 'section', sectionRaw);
                    }
                    if (sectionLower.includes('triple set')) {
                        return buildMeta('triple', 'section', sectionRaw);
                    }
                    if (sectionLower.includes('circuit')) {
                        return buildMeta('circuit', 'section', sectionRaw);
                        }
                        if (sectionRaw && subsectionRaw) {
                            const combined = `${sectionRaw} ${subsectionRaw}`;
                        const combinedLower = combined.toLowerCase();
                        if (combinedLower.includes('giant set')) {
                                return buildMeta('giant', 'combined', combined);
                            }
                        if (combinedLower.includes('superset')) {
                                return buildMeta('superset', 'combined', combined);
                        }
                        if (combinedLower.includes('triple set')) {
                            return buildMeta('triple', 'combined', combined);
                        }
                        if (combinedLower.includes('circuit')) {
                            return buildMeta('circuit', 'combined', combined);
                            }
                        }
                        if (nameRaw) {
                        if (nameLower.includes('giant set')) {
                                return buildMeta('giant', 'name', nameRaw);
                            }
                        if (nameLower.includes('superset')) {
                                return buildMeta('superset', 'name', nameRaw);
                        }
                        if (nameLower.includes('triple set')) {
                            return buildMeta('triple', 'name', nameRaw);
                        }
                        if (nameLower.includes('circuit')) {
                            return buildMeta('circuit', 'name', nameRaw);
                            }
                        }

        const directTypeFromRest = detectGroupType(restRaw);
        const directTypeFromNotes = detectGroupType(notesRaw);
        const directType = directTypeFromRest || directTypeFromNotes;
        if (directType) {
            const sourceText = directTypeFromRest ? restRaw : notesRaw;
            const parsedMembers = collectMembersFromText(sourceText, exercises, index);
                        const hasStructure = sourceText.includes(':') || /(perform|followed|includes|circuit|compound)/i.test(sourceText);
            if (parsedMembers.size >= 2 || hasStructure) {
                return buildMetaFromText(directType, sourceText, index, exercises, parsedMembers);
            }
        }

        const normalizedName = normalizeExerciseName(nameRaw);
        if (normalizedName) {
            for (let prev = index - 1; prev >= 0; prev--) {
                const prevRest = typeof exercises[prev]?.rest === 'string' ? exercises[prev].rest.trim() : '';
                const prevNotes = typeof exercises[prev]?.notes === 'string' ? exercises[prev].notes.trim() : '';
                const prevTypeFromRest = detectGroupType(prevRest);
                const prevTypeFromNotes = detectGroupType(prevNotes);
                const prevType = prevTypeFromRest || prevTypeFromNotes;
                if (!prevType) continue;
                const prevText = prevTypeFromRest ? prevRest : prevNotes;
                const parsedMembers = collectMembersFromText(prevText, exercises, prev);
                const hasStructure = prevText.includes(':') || /(perform|followed|includes|circuit|compound)/i.test(prevText);
                if (!hasStructure && parsedMembers.size < 2) continue;
                const members = ensureMembers(prevType, new Set(parsedMembers), exercises, prev);
                if (members.has(normalizedName)) {
                    return buildMetaFromText(prevType, prevText, prev, exercises, members);
                }
            }
        }

        return null;
                    };

                    for (let idx = 0; idx < day.exercises.length; idx++) {
                        const exercise = day.exercises[idx];
                const groupMeta = getGroupMeta(exercise, idx, day.exercises);

                        if (groupMeta) {
                            const groupedExercises = [];
                            while (
                                idx < day.exercises.length &&
                        getGroupMeta(day.exercises[idx], idx, day.exercises)?.key === groupMeta.key
                            ) {
                                groupedExercises.push(day.exercises[idx]);
                                idx++;
                            }
                            idx -= 1;

                            const createGroupBlock = (label, exercisesInGroup) => {
                                const wrapper = document.createElement('div');
                                wrapper.className = `group-block group-block--${groupMeta.type} space-y-4`;

                                const heading = document.createElement('div');
                                heading.className = 'group-heading';
                                heading.innerHTML = `
                                    <p class="group-label">${label}</p>
                                    <p class="group-caption">${groupMeta.caption}</p>
                                `;
                                wrapper.appendChild(heading);

                                exercisesInGroup.forEach(groupExercise => {
                                    exerciseCounter += 1;
                                    const row = createExerciseRow(groupExercise, `#${exerciseCounter}`, { compact: true, stripPrefix: true });
                                    wrapper.appendChild(row);
                                });

                                exerciseList.appendChild(wrapper);
                            };

                            let buckets = [groupedExercises];
                            if (!groupMeta.derivedFromRest && ['superset', 'triple', 'circuit'].includes(groupMeta.type)) {
                                const hasNumberedPrefixes = groupedExercises.some(ex => {
                                    const name = typeof ex.name === 'string' ? ex.name.trim() : '';
                                    return /^\d+[A-Za-z]+/.test(name);
                                });

                                if (!hasNumberedPrefixes) {
                                    const fallbackBuckets = [];
                                    const defaultChunk = groupMeta.type === 'triple' ? 3 : groupedExercises.length === 1 ? 1 : 2;
                                    const chunkSize = groupMeta.type === 'circuit' ? defaultChunk : defaultChunk;
                                    for (let start = 0; start < groupedExercises.length; start += chunkSize) {
                                        fallbackBuckets.push(groupedExercises.slice(start, start + chunkSize));
                                    }
                                    if (fallbackBuckets.length > 1) {
                                        const lastBucket = fallbackBuckets[fallbackBuckets.length - 1];
                                        if (lastBucket.length === 1) {
                                            fallbackBuckets[fallbackBuckets.length - 2] = fallbackBuckets[fallbackBuckets.length - 2].concat(lastBucket);
                                            fallbackBuckets.pop();
                                        }
                                    }
                                    buckets = fallbackBuckets;
                                } else {
                                const bucketsByPrefix = new Map();
                                groupedExercises.forEach(ex => {
                                    const name = typeof ex.name === 'string' ? ex.name.trim() : '';
                                    const match = name.match(/^(\d+)([A-Za-z]+)/);
                                    const key = match ? `${match[1]}${match[2].toUpperCase()}` : null;
                                    if (!key) {
                                        const fallbackKey = `fallback-${bucketsByPrefix.size}`;
                                        if (!bucketsByPrefix.has(fallbackKey)) {
                                            bucketsByPrefix.set(fallbackKey, []);
                                        }
                                        bucketsByPrefix.get(fallbackKey).push(ex);
                                        return;
                                    }
                                    if (!bucketsByPrefix.has(match[1])) {
                                        bucketsByPrefix.set(match[1], []);
                                    }
                                    bucketsByPrefix.get(match[1]).push(ex);
                                });
                                const sortedKeys = Array.from(bucketsByPrefix.keys())
                                    .map(key => Number.isNaN(Number(key)) ? key : Number(key))
                                    .sort((a, b) => {
                                        if (typeof a === 'number' && typeof b === 'number') return a - b;
                                        if (typeof a === 'number') return -1;
                                        if (typeof b === 'number') return 1;
                                        return String(a).localeCompare(String(b));
                                    });
                                buckets = sortedKeys.map(key => bucketsByPrefix.get(String(key)));
                                }
                            } else if (!groupMeta.derivedFromRest && groupMeta.type === 'giant') {
                                const bucketsByBase = new Map();
                                groupedExercises.forEach(ex => {
                                    const name = typeof ex.name === 'string' ? ex.name.trim() : '';
                                    const match = name.match(/^(\d+)/);
                                    const key = match ? match[1] : `fallback-${bucketsByBase.size}`;
                                    if (!bucketsByBase.has(key)) {
                                        bucketsByBase.set(key, []);
                                    }
                                    bucketsByBase.get(key).push(ex);
                                });
                                const sortedKeys = Array.from(bucketsByBase.keys())
                                    .map(key => Number.isNaN(Number(key)) ? key : Number(key))
                                    .sort((a, b) => {
                                        if (typeof a === 'number' && typeof b === 'number') return a - b;
                                        if (typeof a === 'number') return -1;
                                        if (typeof b === 'number') return 1;
                                        return String(a).localeCompare(String(b));
                                    });
                                buckets = sortedKeys.map(key => bucketsByBase.get(String(key)));
                            }

                            buckets.forEach((bucket, bucketIndex) => {
                                if (!bucket.length) return;
                                let bucketLabel = groupMeta.label;
                                const firstExercise = bucket[0];
                                if (['superset', 'triple', 'circuit'].includes(groupMeta.type)) {
                                    const match = firstExercise && typeof firstExercise.name === 'string'
                                        ? firstExercise.name.trim().match(/^(\d+)([A-Za-z]+)/)
                                        : null;
                                    if (match) {
                                        bucketLabel = `${groupMeta.label} · ${match[1]}${match[2].toUpperCase()}`;
                                    } else if (buckets.length > 1) {
                                        const labelTerm = groupMeta.type === 'circuit' ? 'Circuit' : groupMeta.type === 'triple' ? 'Set' : 'Set';
                                        bucketLabel = `${groupMeta.label} · ${labelTerm} ${bucketIndex + 1}`;
                                    }
                                } else if (groupMeta.type === 'giant' && buckets.length > 1) {
                                    const match = firstExercise && typeof firstExercise.name === 'string'
                                        ? firstExercise.name.trim().match(/^(\d+)/)
                                        : null;
                                    if (match) {
                                        bucketLabel = `${groupMeta.label} · Round ${match[1]}`;
                                    } else {
                                        bucketLabel = `${groupMeta.label} · Round ${bucketIndex + 1}`;
                                    }
                                }

                                createGroupBlock(bucketLabel, bucket);
                            });
                        } else {
                            exerciseCounter += 1;
                            const item = createExerciseRow(exercise, `#${exerciseCounter}`);
                            exerciseList.appendChild(item);
                        }
                    }
                }

                workoutContent.appendChild(workoutCard);
            }

            // 2.5 Training Notes
            const noteCard = document.createElement('div');
            noteCard.className = 'bg-gray-800 rounded-lg border border-gray-700 overflow-hidden shadow-lg';
            const notesPanelId = `training-notes-${weekNumber}-${dayNumber}`;
            noteCard.innerHTML = `
                <div class="overflow-hidden">
                    <button class="collapsible-trigger w-full flex items-center justify-between px-4 py-3 text-left focus:outline-none" aria-expanded="true" aria-controls="${notesPanelId}">
                        <div>
                            <h2 class="text-xl font-bold text-white">Training Notes</h2>
                            <p class="text-xs text-gray-400">Tap to collapse or expand</p>
                        </div>
                        <svg class="w-4 h-4 text-gray-400 icon-rotate" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                    <div id="${notesPanelId}" class="collapsible-card expanded">
                        <div class="p-4 space-y-3">
                            <p class="text-sm text-gray-400">Capture weights, pacing, or how you felt.</p>
                        </div>
                    </div>
                </div>
            `;
            const notesContainer = noteCard.querySelector('.collapsible-card .p-4');
            const noteTextarea = document.createElement('textarea');
            noteTextarea.className = 'w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none';
            noteTextarea.rows = 4;
            noteTextarea.value = getDayNote(programName, weekNumber, dayNumber);

            let noteSaveTimer;
            noteTextarea.addEventListener('input', (event) => {
                clearTimeout(noteSaveTimer);
                const value = event.target.value;
                noteSaveTimer = setTimeout(() => {
                    setDayNote(programName, weekNumber, dayNumber, value);
                }, 250);
            });

            const previousHistory = historyCache.find(entry => entry.programId === programName && entry.week === weekNumber && entry.summary && entry.summary[String(dayNumber)]);
            const historyBlock = document.createElement('div');
            historyBlock.className = 'bg-gray-900 border border-gray-800 rounded-lg p-3';
            if (previousHistory) {
                const date = new Date(previousHistory.timestamp).toLocaleDateString();
                historyBlock.innerHTML = `
                    <p class="text-xs uppercase tracking-wider text-gray-500">Previously Logged</p>
                    <p class="text-sm text-gray-300">${previousHistory.summary[String(dayNumber)]}</p>
                    <p class="text-xs text-gray-500 mt-2">Completed on ${date}</p>
                `;
            } else {
                historyBlock.innerHTML = `
                    <p class="text-xs uppercase tracking-wider text-gray-500">Previously Logged</p>
                    <p class="text-sm text-gray-400">Complete this week to start building history.</p>
                `;
            }

            notesContainer.appendChild(noteTextarea);
            notesContainer.appendChild(historyBlock);
            workoutContent.appendChild(noteCard);

            setupCollapsibles(workoutContent);
            
            showPage('page-workout-details');

            saveProgress({
                programId: programName,
                trainerId: currentTrainer || findTrainerForProgram(programName),
                week: weekNumber,
                day: dayNumber,
                dayTitle: day.title
            });
            updateContinueCard();
        }

        function completeWorkout() {
            if (!currentProgram || !currentWeek) {
            showMessage("Workout complete!");
                return;
            }

            showMessage("Workout complete!");

            const program = programs[currentProgram];
            const weekData = program && program.weeks ? program.weeks.find(w => w.week === currentWeek) : null;
            const days = weekData && Array.isArray(weekData.days) ? weekData.days : [];
            const lastDayNumber = days.length ? days[days.length - 1].day : null;
            const isFinalDay = lastDayNumber === currentDay;
            const weekNotes = getWeekNotes(currentProgram, currentWeek);
            const hasNotes = Object.keys(weekNotes).length > 0;

            if (isFinalDay && hasNotes) {
                logWeekCompletion(currentProgram, currentWeek, weekNotes);
                showSummaryModal(currentProgram, currentWeek, weekNotes);
                pendingNavigation = { type: 'week', program: currentProgram, week: currentWeek };
            } else {
                showWeek(currentProgram, currentWeek);
            }
        }

        // Custom message function
        function showMessage(text) {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            
            messageText.textContent = text;
            messageBox.classList.remove('hidden');

            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 2000);
        }

        // --- PROGRESS SAVING (Coming soon) ---
        // We'll use localStorage to save the current program and week

        // Initialize the app on first load
        showPage('page-main-menu');
        updateContinueCard();
        buildSearchIndex();
        renderTrainerCards();
        initSplashSequence();

        continueBtn.addEventListener('click', () => {
            const programId = continueBtn.dataset.program;
            const week = Number(continueBtn.dataset.week);
            const day = Number(continueBtn.dataset.day);
            if (continueBtn.dataset.trainer) {
                currentTrainer = continueBtn.dataset.trainer;
            }
            resumeProgress(programId, week, day);
        });
        resetProgressBtn.addEventListener('click', () => {
            clearProgress();
        });

        openSearchBtn.addEventListener('click', () => {
            searchOverlay.classList.add('active');
            searchInput.focus();
            searchInput.value = '';
            searchResults.innerHTML = '';
        });
        closeSearchBtn.addEventListener('click', () => {
            searchOverlay.classList.remove('active');
        });
        searchInput.addEventListener('input', (e) => {
            renderSearchResults(e.target.value);
        });
        searchOverlay.addEventListener('click', (e) => {
            if (e.target === searchOverlay) {
                searchOverlay.classList.remove('active');
            }
        });
        if (openStatsBtn) {
            openStatsBtn.addEventListener('click', showStatsOverlay);
        }
        if (quickExportBtn) {
            quickExportBtn.addEventListener('click', triggerExport);
        }
        if (closeStatsBtn) {
            closeStatsBtn.addEventListener('click', hideStatsOverlay);
        }
        if (statsOverlay) {
            statsOverlay.addEventListener('click', (e) => {
                if (e.target === statsOverlay) {
                    hideStatsOverlay();
                }
            });
        }
        if (exportDataBtn) {
            exportDataBtn.addEventListener('click', triggerExport);
        }
        if (importDataBtn && importInput) {
            importDataBtn.addEventListener('click', () => importInput.click());
            importInput.addEventListener('change', async (event) => {
                const file = event.target.files && event.target.files[0];
                if (file) {
                    try {
                        await handleImportFile(file);
                    } catch (err) {
                        // errors already surfaced via showMessage
                    } finally {
                        importInput.value = '';
                    }
                }
            });
        }
        closeSummaryBtn.addEventListener('click', hideSummaryModal);
        summaryOverlay.addEventListener('click', (e) => {
            if (e.target === summaryOverlay) {
                hideSummaryModal();
            }
        });

        if (thenxLibraryBack) {
            thenxLibraryBack.addEventListener('click', () => {
                goToTrainerPage();
            });
        }
        if (thenxSearchInput) {
            thenxSearchInput.addEventListener('input', (event) => {
                if (thenxSearchTimeout) {
                    clearTimeout(thenxSearchTimeout);
                }
                thenxSearchTimeout = setTimeout(() => {
                    thenxFilterState.search = event.target.value.trim().toLowerCase();
                    if (programs.thenxLibrary) {
                        renderThenxLibraryList(programs.thenxLibrary);
                    }
                }, THENX_SEARCH_DELAY);
            });
        }
        if (thenxClearFiltersBtn) {
            thenxClearFiltersBtn.addEventListener('click', () => {
                thenxFilterState = { focus: 'all', search: '' };
                if (thenxSearchInput) {
                    thenxSearchInput.value = '';
                }
                renderThenxFocusFilters();
                if (programs.thenxLibrary) {
                    renderThenxLibraryList(programs.thenxLibrary);
                }
            });
        }

        function loadThenxFavorites() {
            try {
                const raw = localStorage.getItem(THENX_FAVORITES_KEY);
                if (!raw) return new Set();
                return new Set(JSON.parse(raw));
            } catch (error) {
                console.warn('Unable to load ThenX favorites', error);
                return new Set();
            }
        }

        function saveThenxFavorites(favorites) {
            try {
                localStorage.setItem(THENX_FAVORITES_KEY, JSON.stringify(Array.from(favorites)));
            } catch (error) {
                console.warn('Unable to save ThenX favorites', error);
            }
        }

        function toggleThenxFavorite(url, program) {
            if (thenxFavorites.has(url)) {
                thenxFavorites.delete(url);
            } else {
                thenxFavorites.add(url);
            }
            saveThenxFavorites(thenxFavorites);
            if (thenxFilterState.focus === 'favorites' && thenxFavorites.size === 0) {
                thenxFilterState.focus = 'all';
            }
            renderThenxFocusFilters();
            if (program) {
                renderThenxLibraryList(program);
            }
        }

        // Collapsible cards
        function setupCollapsibles(scope = document) {
            const triggers = scope.querySelectorAll('.collapsible-trigger');
            triggers.forEach(trigger => {
                if (trigger.dataset.collapsibleBound === 'true') return;
                const card = trigger.nextElementSibling;
                if (!card || !card.classList.contains('collapsible-card')) return;
                trigger.dataset.collapsibleBound = 'true';
                if (!trigger.hasAttribute('aria-expanded')) {
                    trigger.setAttribute('aria-expanded', 'true');
                }
                trigger.addEventListener('click', () => {
                    const expanded = trigger.getAttribute('aria-expanded') === 'true';
                    trigger.setAttribute('aria-expanded', String(!expanded));
                    card.classList.toggle('expanded', !expanded);
                });
            });
        }
        setupCollapsibles(document);
    </script>
</body>
</html>