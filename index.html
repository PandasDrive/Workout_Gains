<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <!-- These tags are what make it feel like a PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sculpted Fitness Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent; /* Removes blue flash on tap */
            background-color: #111827; /* Same as bg-gray-900 */
            color: #e5e7eb; /* Same as text-gray-200 */
            min-height: 100vh;
            position: relative;
        }
        .btn-press {
            transition: all 0.1s ease;
        }
        .btn-press:active {
            transform: scale(0.98);
            filter: brightness(0.9);
        }
        
        /* Page Navigation System */
        .no-js .page {
            position: static;
            display: block;
            animation: none;
            padding: 1.5rem;
        }
        .no-js .page + .page {
            margin-top: 2rem;
        }
        .js-enabled .page {
            display: none; /* Hidden by default when JS is enabled */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transform: translateY(16px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .js-enabled .page.active {
            display: block; /* Show active page */
        }
        .js-enabled .page.entering {
            opacity: 0;
            transform: translateY(16px);
        }
        .js-enabled .page.entered {
            opacity: 1;
            transform: translateY(0);
        }
        .js-enabled .page.leaving {
            opacity: 0;
            transform: translateY(-16px);
        }
        .page-content {
            height: 100vh;
            overflow-y: auto;
            /* Added more bottom padding for the 'Complete' button */
            padding: 1.5rem 1.5rem 8rem 1.5rem; 
        }
        .no-js .page-content {
            height: auto;
            overflow: visible;
            padding: 1rem 0;
        }
        /* Style for the header on sub-pages */
        .page-header {
            position: sticky;
            top: 0;
            /* This is the same as bg-gray-900 */
            background-color: #111827; 
            padding-top: 1.5rem;
            padding-bottom: 1rem;
            /* This is the same as border-gray-700 */
            border-bottom: 1px solid #374151; 
            z-index: 10;
        }
        .continue-card {
            border: 1px solid #2563eb33;
            background: linear-gradient(135deg, rgba(37,99,235,0.15), rgba(59,130,246,0.05));
        }
        .search-trigger {
            border: 1px solid #374151;
        }
        .search-overlay {
            position: fixed;
            inset: 0;
            background: rgba(17,24,39,0.95);
            display: none;
            flex-direction: column;
            padding: 2.5rem 1.5rem;
            z-index: 50;
        }
        .search-overlay.active {
            display: flex;
        }
        .search-input {
            background-color: #1f2937;
            border: 1px solid #374151;
        }
        .search-result {
            border: 1px solid #1f2937;
        }
        .stats-overlay {
            position: fixed;
            inset: 0;
            background: rgba(17,24,39,0.92);
            display: none;
            flex-direction: column;
            padding: 2.5rem 1.5rem;
            z-index: 55;
        }
        .stats-overlay.active {
            display: flex;
        }
    </style>
</head>
<body class="no-js h-full text-gray-200 antialiased">

    <!-- Page 1: Main Menu -->
    <div id="page-main-menu" class="page active">
        <div class="flex flex-col h-full items-center justify-center p-6 bg-gray-900">
            <header class="text-center mb-12">
                <h1 class="text-4xl font-bold text-white mb-2">Sculpted Fitness Tracker</h1>
                <p class="text-lg text-gray-400">Your personal program tracker.</p>
            </header>
            <main class="w-full max-w-xl space-y-6">
                <div class="flex items-center justify-between">
                    <div class="text-left">
                        <p class="text-sm uppercase tracking-widest text-blue-400">Welcome Back</p>
                        <p class="text-2xl font-semibold text-white">Your Programs</p>
                    </div>
                    <button id="open-search" class="search-trigger btn-press px-4 py-2 rounded-xl flex items-center text-sm font-medium text-blue-300 hover:text-white">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M10 18a8 8 0 100-16 8 8 0 000 16z"></path></svg>
                        Search Workouts
                    </button>
                </div>

                <div id="continue-card" class="continue-card hidden rounded-2xl p-5 flex flex-col md:flex-row md:items-center md:justify-between">
                    <div class="mb-4 md:mb-0">
                        <p class="text-sm uppercase tracking-wider text-blue-300">Continue</p>
                        <p id="continue-title" class="text-lg font-semibold text-white"></p>
                        <p id="continue-subtitle" class="text-sm text-gray-300"></p>
                    </div>
                    <div class="space-y-2 md:space-y-0 md:space-x-3 md:flex">
                        <button id="continue-btn" class="btn-press bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">Resume Workout</button>
                        <button id="reset-progress" class="btn-press text-sm text-gray-300 hover:text-white px-4 py-2 rounded-lg border border-transparent">Reset</button>
                    </div>
                </div>

                <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider text-center mb-4">Select a Program</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="showProgram('gethin')" class="btn-press flex items-center justify-between w-full p-6 bg-gray-800 rounded-2xl shadow-lg border border-gray-700">
                        <div class="text-left">
                            <p class="text-lg font-semibold text-white">Kris Gethin</p>
                            <p class="text-sm text-gray-400">Legacy Program</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                    <button onclick="showProgram('nippard')" class="btn-press flex items-center justify-between w-full p-6 bg-gray-800 rounded-2xl shadow-lg border border-gray-700">
                        <div class="text-left">
                            <p class="text-lg font-semibold text-white">Jeff Nippard</p>
                            <p class="text-sm text-gray-400">12-Week Program</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>

                <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6 shadow-lg flex flex-col md:flex-row md:items-center md:justify-between">
                    <div class="mb-4 md:mb-0">
                        <p class="text-sm uppercase tracking-wider text-blue-300">Progress Hub</p>
                        <p class="text-lg font-semibold text-white">Visualize & Backup Your Journey</p>
                        <p class="text-sm text-gray-400">Review completed weeks, compare past runs, and export your data at any time.</p>
                    </div>
                    <div class="space-y-3 md:space-y-0 md:space-x-3 md:flex">
                        <button id="open-stats" class="btn-press bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">View Progress</button>
                        <button id="quick-export" class="btn-press px-4 py-2 rounded-lg border border-gray-600 text-sm text-gray-200 hover:text-white">Quick Export</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Page 2: Week List -->
    <div id="page-program-weeks" class="page">
        <div class="page-content bg-gray-900">
            <header class="page-header flex items-center justify-between mb-6">
                <button onclick="showPage('page-main-menu')" class="btn-press flex items-center text-blue-400 text-lg">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Back
                </button>
                <h1 id="program-title" class="text-2xl font-bold text-white text-right"></h1>
            </header>
            <main id="week-list" class="space-y-3"></main>
        </div>
    </div>

    <!-- Page 3: Day List -->
    <div id="page-week-days" class="page">
        <div class="page-content bg-gray-900">
            <header class="page-header flex items-center justify-between mb-6">
                <button onclick="showProgram(currentProgram)" class="btn-press flex items-center text-blue-400 text-lg">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Weeks
                </button>
                <h1 id="week-title" class="text-2xl font-bold text-white text-right"></h1>
            </header>
            <main id="day-list" class="space-y-3"></main>
        </div>
    </div>

    <!-- Page 4: Workout Details -->
    <div id="page-workout-details" class="page">
        <div class="page-content bg-gray-900">
            <header class="page-header flex items-center justify-between mb-6">
                <button onclick="showWeek(currentProgram, currentWeek)" class="btn-press flex items-center text-blue-400 text-lg">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Days
                </button>
                <h1 id="day-title" class="text-xl font-bold text-white text-right"></h1>
            </header>
            
            <!-- Main workout content -->
            <main id="workout-content" class="space-y-6"></main>

            <!-- Complete button -->
            <div class="fixed bottom-0 left-0 right-0 p-4 bg-gray-900 border-t border-gray-700">
                <button onclick="completeWorkout()" class="btn-press w-full py-4 px-6 bg-blue-600 hover:bg-blue-700 text-white text-lg font-semibold rounded-xl shadow-lg">
                    Complete Workout
                </button>
            </div>
        </div>
    </div>

    <!-- Message box for alerts -->
    <div id="message-box" class="hidden fixed bottom-24 left-1/2 -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-xl shadow-lg z-50">
        <p id="message-text"></p>
    </div>

    <!-- Weekly Summary Modal -->
    <div id="summary-overlay" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl max-w-xl w-full p-6 space-y-5 shadow-2xl">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm uppercase tracking-widest text-blue-400">Weekly Snapshot</p>
                    <h2 id="summary-title" class="text-2xl font-semibold text-white"></h2>
                </div>
                <button id="close-summary" class="btn-press text-gray-400 hover:text-white">Close</button>
            </div>
            <div class="bg-gray-800 rounded-xl border border-gray-700 p-4 space-y-3">
                <div>
                    <p class="text-xs uppercase tracking-wider text-gray-400">Cardio Completed</p>
                    <p id="summary-cardio" class="text-lg font-semibold text-white"></p>
                </div>
                <div>
                    <p class="text-xs uppercase tracking-wider text-gray-400">Weekly Task</p>
                    <p id="summary-task" class="text-sm text-gray-300"></p>
                </div>
                <div>
                    <p class="text-xs uppercase tracking-wider text-gray-400">Notes Entered</p>
                    <ul id="summary-notes" class="text-sm text-gray-300 space-y-1"></ul>
                </div>
            </div>
            <div>
                <p class="text-xs uppercase tracking-wider text-gray-400">Historical Notes</p>
                <div id="summary-history" class="bg-gray-800 rounded-xl border border-gray-700 p-4 space-y-3 max-h-48 overflow-y-auto text-sm text-gray-300"></div>
            </div>
        </div>
    </div>

    <!-- Stats & Backup Overlay -->
    <div id="stats-overlay" class="stats-overlay">
        <div class="flex items-center justify-between mb-6">
            <div>
                <p class="text-sm uppercase tracking-widest text-blue-400">Progress & Backup</p>
                <h2 class="text-2xl font-semibold text-white">Your Training History</h2>
            </div>
            <button id="close-stats" class="btn-press text-gray-400 hover:text-white">Close</button>
        </div>
        <div id="stats-empty" class="flex-1 flex items-center justify-center text-gray-500 text-center hidden">
            <div>
                <p class="text-lg font-semibold text-gray-300">No completed weeks yet.</p>
                <p class="text-sm text-gray-400 mt-2">Log notes and finish a week to start building your history.</p>
            </div>
        </div>
        <div id="stats-content" class="flex-1 space-y-6 overflow-y-auto">
            <div class="bg-gray-900 border border-gray-700 rounded-2xl p-4">
                <canvas id="progress-chart" height="220"></canvas>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-gray-900 border border-gray-700 rounded-2xl p-4">
                    <p class="text-xs uppercase tracking-wider text-gray-400">Totals</p>
                    <div class="mt-3 space-y-2">
                        <p class="text-sm text-gray-300">Completed Weeks: <span id="stats-weeks" class="text-blue-300 font-semibold">0</span></p>
                        <p class="text-sm text-gray-300">Notes Captured: <span id="stats-notes" class="text-blue-300 font-semibold">0</span></p>
                        <p class="text-sm text-gray-300">Programs Logged: <span id="stats-programs" class="text-blue-300 font-semibold">0</span></p>
                    </div>
                </div>
                <div class="bg-gray-900 border border-gray-700 rounded-2xl p-4 space-y-3">
                    <p class="text-xs uppercase tracking-wider text-gray-400">Backup & Restore</p>
                    <p class="text-sm text-gray-400">Export your notes, progress, and history for safe keeping—or import a previous backup to restore everything.</p>
                    <div class="space-y-2">
                        <button id="export-data" class="btn-press w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">Download Backup</button>
                        <button id="import-data" class="btn-press w-full px-4 py-2 rounded-lg border border-gray-600 text-sm text-gray-200 hover:text-white">Import Backup</button>
                        <input type="file" id="import-input" accept="application/json" class="hidden" />
                    </div>
                </div>
            </div>
            <div class="bg-gray-900 border border-gray-700 rounded-2xl p-4">
                <p class="text-xs uppercase tracking-wider text-gray-400">Recent History</p>
                <div id="stats-history" class="mt-3 space-y-3 text-sm text-gray-300"></div>
            </div>
        </div>
    </div>

    <!-- Search Overlay -->
    <div id="search-overlay" class="search-overlay">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-semibold text-white">Search Exercises</h2>
            <button id="close-search" class="btn-press text-gray-400 hover:text-white text-sm">Close</button>
        </div>
        <div class="mb-6">
            <input id="search-input" type="text" placeholder="Search by exercise name..." class="search-input w-full px-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-white placeholder-gray-500" />
            <p class="text-sm text-gray-400 mt-2">Tip: try "squat", "pulldown", or "DTP".</p>
        </div>
        <div id="search-results" class="overflow-y-auto space-y-3"></div>
    </div>

    <script src="data/program-data.js"></script>
    <script>
        document.body.classList.remove('no-js');
        document.body.classList.add('js-enabled');

        // --- DATABASE ---
        const programs = window.programs || {};
        if (!Object.keys(programs).length) {
            console.warn("Program data is not loaded.");
        }

        const PROGRESS_KEY = 'fitnessProgress';
        const NOTES_KEY = 'fitnessNotes';
        const HISTORY_KEY = 'fitnessHistory';
        const continueCard = document.getElementById('continue-card');
        const continueTitle = document.getElementById('continue-title');
        const continueSubtitle = document.getElementById('continue-subtitle');
        const continueBtn = document.getElementById('continue-btn');
        const resetProgressBtn = document.getElementById('reset-progress');
        const searchOverlay = document.getElementById('search-overlay');
        const openSearchBtn = document.getElementById('open-search');
        const closeSearchBtn = document.getElementById('close-search');
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const openStatsBtn = document.getElementById('open-stats');
        const quickExportBtn = document.getElementById('quick-export');
        const statsOverlay = document.getElementById('stats-overlay');
        const closeStatsBtn = document.getElementById('close-stats');
        const exportDataBtn = document.getElementById('export-data');
        const importDataBtn = document.getElementById('import-data');
        const importInput = document.getElementById('import-input');
        const statsEmpty = document.getElementById('stats-empty');
        const statsContent = document.getElementById('stats-content');
        const statsWeeks = document.getElementById('stats-weeks');
        const statsNotes = document.getElementById('stats-notes');
        const statsPrograms = document.getElementById('stats-programs');
        const statsHistoryContainer = document.getElementById('stats-history');
        const progressChartCanvas = document.getElementById('progress-chart');
        const summaryOverlay = document.getElementById('summary-overlay');
        const closeSummaryBtn = document.getElementById('close-summary');
        const summaryTitle = document.getElementById('summary-title');
        const summaryCardio = document.getElementById('summary-cardio');
        const summaryTask = document.getElementById('summary-task');
        const summaryNotes = document.getElementById('summary-notes');
        const summaryHistory = document.getElementById('summary-history');
        let searchIndex = [];
        let notesCache = loadNotes();
        let historyCache = loadHistory();
        let pendingNavigation = null;
        let progressChartInstance = null;

        function loadProgress() {
            try {
                const stored = localStorage.getItem(PROGRESS_KEY);
                return stored ? JSON.parse(stored) : null;
            } catch (err) {
                console.error('Failed to load progress', err);
                return null;
            }
        }

        function loadNotes() {
            try {
                const stored = localStorage.getItem(NOTES_KEY);
                return stored ? JSON.parse(stored) : {};
            } catch (err) {
                console.error('Failed to load notes', err);
                return {};
            }
        }

        function saveNotes(notes) {
            try {
                localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
                notesCache = notes;
            } catch (err) {
                console.error('Failed to save notes', err);
            }
        }

        function loadHistory() {
            try {
                const stored = localStorage.getItem(HISTORY_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (err) {
                console.error('Failed to load history', err);
                return [];
            }
        }

        function saveHistory(history) {
            try {
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                historyCache = history;
            } catch (err) {
                console.error('Failed to save history', err);
            }
        }

        function getWeekNotes(programId, weekNumber) {
            return (notesCache[programId] && notesCache[programId][weekNumber]) ? { ...notesCache[programId][weekNumber] } : {};
        }

        function getDayNote(programId, weekNumber, dayNumber) {
            const programNotes = notesCache[programId];
            if (!programNotes) return '';
            const weekNotes = programNotes[weekNumber];
            if (!weekNotes) return '';
            return weekNotes[dayNumber] || '';
        }

        function setDayNote(programId, weekNumber, dayNumber, value) {
            if (!notesCache[programId]) {
                notesCache[programId] = {};
            }
            if (!notesCache[programId][weekNumber]) {
                notesCache[programId][weekNumber] = {};
            }
            if (value && value.trim()) {
                notesCache[programId][weekNumber][dayNumber] = value.trim();
            } else {
                delete notesCache[programId][weekNumber][dayNumber];
                if (Object.keys(notesCache[programId][weekNumber]).length === 0) {
                    delete notesCache[programId][weekNumber];
                }
            }
            saveNotes(notesCache);
            if (statsOverlay.classList.contains('active')) {
                renderStatsView();
            }
        }

        function collectExportData() {
            return {
                version: 1,
                generatedAt: new Date().toISOString(),
                progress: loadProgress(),
                notes: notesCache,
                history: historyCache
            };
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const anchor = document.createElement('a');
            anchor.href = url;
            anchor.download = filename;
            document.body.appendChild(anchor);
            anchor.click();
            document.body.removeChild(anchor);
            URL.revokeObjectURL(url);
        }

        function triggerExport() {
            const data = collectExportData();
            const timestamp = new Date().toISOString().split('T')[0];
            downloadJSON(data, `sculpted-fitness-backup-${timestamp}.json`);
            showMessage('Backup downloaded');
        }

        function aggregateCurrentNoteCount() {
            let total = 0;
            Object.values(notesCache).forEach(weekMap => {
                if (weekMap && typeof weekMap === 'object') {
                    Object.values(weekMap).forEach(dayNote => {
                        if (typeof dayNote === 'string' && dayNote.trim()) {
                            total += 1;
                        }
                    });
                }
            });
            return total;
        }

        function renderStatsView() {
            if (!statsOverlay) return;

            const hasHistory = historyCache.length > 0;
            const currentNotes = aggregateCurrentNoteCount();

            if (!hasHistory && currentNotes === 0) {
                statsEmpty.classList.remove('hidden');
                statsContent.classList.add('hidden');
                statsHistoryContainer.innerHTML = '';
                statsWeeks.textContent = '0';
                statsNotes.textContent = '0';
                statsPrograms.textContent = '0';
                if (progressChartInstance) {
                    progressChartInstance.destroy();
                    progressChartInstance = null;
                }
                return;
            }

            statsEmpty.classList.add('hidden');
            statsContent.classList.remove('hidden');

            const chronological = historyCache.slice().reverse();
            const labels = chronological.map(entry => `${entry.programTitle || entry.programId} W${entry.week}`);
            const dataPoints = chronological.map(entry => Object.keys(entry.summary || {}).length);

            if (progressChartInstance) {
                progressChartInstance.data.labels = labels;
                progressChartInstance.data.datasets[0].data = dataPoints;
                progressChartInstance.update();
            } else if (progressChartCanvas) {
                const ctx = progressChartCanvas.getContext('2d');
                progressChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: 'Notes Logged per Week',
                                data: dataPoints,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59,130,246,0.15)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.35,
                                pointRadius: 4,
                                pointBackgroundColor: '#60a5fa'
                            }
                        ]
                    },
                    options: {
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#d1d5db'
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#9ca3af'
                                },
                                grid: {
                                    color: 'rgba(55,65,81,0.3)'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#9ca3af',
                                    precision: 0
                                },
                                grid: {
                                    color: 'rgba(55,65,81,0.3)'
                                }
                            }
                        }
                    }
                });
            }

            const totalWeeks = historyCache.length;
            const historyNotes = historyCache.reduce((sum, entry) => sum + Object.keys(entry.summary || {}).length, 0);
            const programSet = new Set(historyCache.map(entry => entry.programId));
            Object.keys(notesCache || {}).forEach(programId => {
                programSet.add(programId);
            });

            statsWeeks.textContent = String(totalWeeks);
            statsNotes.textContent = String(historyNotes + currentNotes);
            statsPrograms.textContent = String(programSet.size);

            const recentEntries = historyCache.slice(0, 6);
            statsHistoryContainer.innerHTML = '';
            recentEntries.forEach(entry => {
                const wrap = document.createElement('div');
                wrap.className = 'bg-gray-800 border border-gray-700 rounded-xl p-3';
                const date = new Date(entry.timestamp).toLocaleString();
                const notes = Object.entries(entry.summary || {});
                wrap.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-semibold text-white">${entry.programTitle || entry.programId} – Week ${entry.week}</p>
                            <p class="text-xs text-gray-400">${date}</p>
                        </div>
                        <span class="text-xs text-blue-300">${notes.length} notes</span>
                    </div>
                    <ul class="mt-3 space-y-1 text-xs text-gray-300">
                        ${notes.map(([day, note]) => `<li><span class="text-blue-300 font-medium">Day ${day}:</span> ${note}</li>`).join('')}
                    </ul>
                `;
                statsHistoryContainer.appendChild(wrap);
            });
        }

        function showStatsOverlay() {
            statsOverlay.classList.add('active');
            renderStatsView();
        }

        function hideStatsOverlay() {
            statsOverlay.classList.remove('active');
        }

        function applyImportedData(payload) {
            if (!payload || typeof payload !== 'object') {
                throw new Error('Invalid backup');
            }

            if (payload.notes && typeof payload.notes === 'object') {
                saveNotes(payload.notes);
            } else {
                saveNotes({});
            }

            if (payload.history && Array.isArray(payload.history)) {
                saveHistory(payload.history);
            } else {
                saveHistory([]);
            }

            if (payload.progress) {
                saveProgress(payload.progress);
            } else {
                localStorage.removeItem(PROGRESS_KEY);
            }

            notesCache = loadNotes();
            historyCache = loadHistory();
            updateContinueCard();
            renderStatsView();
            showMessage('Backup imported');
        }

        function handleImportFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const payload = JSON.parse(event.target.result);
                        applyImportedData(payload);
                        resolve();
                    } catch (err) {
                        console.error('Failed to import backup', err);
                        showMessage('Import failed');
                        reject(err);
                    }
                };
                reader.onerror = err => {
                    console.error('Failed to read file', err);
                    showMessage('Import failed');
                    reject(err);
                };
                reader.readAsText(file);
            });
        }

        function saveProgress(data) {
            try {
                localStorage.setItem(PROGRESS_KEY, JSON.stringify(data));
            } catch (err) {
                console.error('Failed to save progress', err);
            }
        }

        function clearProgress() {
            localStorage.removeItem(PROGRESS_KEY);
            updateContinueCard();
        }

        function updateContinueCard() {
            const progress = loadProgress();
            if (!progress) {
                continueCard.classList.add('hidden');
                return;
            }
            const program = programs[progress.programId];
            if (!program) {
                continueCard.classList.add('hidden');
                return;
            }
            continueCard.classList.remove('hidden');
            continueTitle.textContent = `${program.title} – Week ${progress.week}, Day ${progress.day}`;
            continueSubtitle.textContent = `Last visited: ${progress.dayTitle}`;
            continueBtn.dataset.program = progress.programId;
            continueBtn.dataset.week = progress.week;
            continueBtn.dataset.day = progress.day;
        }

        function resumeProgress(programId, weekNumber, dayNumber) {
            showProgram(programId);
            showWeek(programId, weekNumber);
            showDay(programId, weekNumber, dayNumber);
            searchOverlay.classList.remove('active');
        }

        function logWeekCompletion(programId, weekNumber, summary) {
            const entry = {
                id: `${programId}-${weekNumber}-${Date.now()}`,
                timestamp: Date.now(),
                programId,
                programTitle: programs[programId]?.title || programId,
                week: weekNumber,
                summary
            };
            historyCache.unshift(entry);
            if (historyCache.length > 100) {
                historyCache = historyCache.slice(0, 100);
            }
            saveHistory(historyCache);
            if (statsOverlay.classList.contains('active')) {
                renderStatsView();
            }
        }

        function formatCardioSummary(days) {
            const cardioLines = days
                .map(day => day.cardio)
                .filter(Boolean);
            if (!cardioLines.length) return 'No cardio logged this week.';
            const uniqueLines = Array.from(new Set(cardioLines));
            return uniqueLines.join('\n');
        }

        function showSummaryModal(programId, weekNumber, weekNotes) {
            const program = programs[programId];
            if (!program) return;
            const weekData = program.weeks.find(w => w.week === weekNumber);
            if (!weekData) return;

            summaryTitle.textContent = `${program.title} – Week ${weekNumber}`;
            const cardioSummary = formatCardioSummary(weekData.days);
            summaryCardio.innerHTML = cardioSummary.replace(/\n/g, '<br>');
            summaryTask.textContent = weekData.task || 'No weekly task logged.';

            summaryNotes.innerHTML = '';
            const noteEntries = Object.entries(weekNotes || {});
            if (noteEntries.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'No notes entered this week.';
                summaryNotes.appendChild(li);
            } else {
                noteEntries.sort((a, b) => Number(a[0]) - Number(b[0]));
                noteEntries.forEach(([day, note]) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="text-blue-300">Day ${day}:</span> ${note}`;
                    summaryNotes.appendChild(li);
                });
            }

            summaryHistory.innerHTML = '';
            const matchingHistory = historyCache.filter(entry => entry.programId === programId && entry.week === weekNumber);
            if (!matchingHistory.length) {
                const p = document.createElement('p');
                p.className = 'text-gray-400';
                p.textContent = 'No previous runs yet. Complete this week to start building your timeline.';
                summaryHistory.appendChild(p);
            } else {
                matchingHistory.forEach(entry => {
                    const wrap = document.createElement('div');
                    const date = new Date(entry.timestamp).toLocaleString();
                    wrap.innerHTML = `
                        <p class="text-xs text-gray-500">${date}</p>
                        <ul class="text-sm text-gray-300 space-y-1">
                            ${Object.entries(entry.summary).map(([day, note]) => `<li><span class="text-blue-300">Day ${day}:</span> ${note}</li>`).join('')}
                        </ul>
                    `;
                    summaryHistory.appendChild(wrap);
                });
            }

            summaryOverlay.classList.remove('hidden');
        }

        function hideSummaryModal() {
            summaryOverlay.classList.add('hidden');
            if (pendingNavigation && pendingNavigation.type === 'week') {
                showWeek(pendingNavigation.program, pendingNavigation.week);
            }
            pendingNavigation = null;
        }

        function buildSearchIndex() {
            searchIndex = [];
            Object.entries(programs).forEach(([programId, program]) => {
                program.weeks.forEach(week => {
                    week.days.forEach(day => {
                        day.exercises.forEach(exercise => {
                            searchIndex.push({
                                programId,
                                programTitle: program.title,
                                week: week.week,
                                weekTask: week.task,
                                day: day.day,
                                dayTitle: day.title,
                                cardio: day.cardio,
                                exerciseName: exercise.name,
                                notes: exercise.notes
                            });
                        });
                    });
                });
            });
        }

        function renderSearchResults(query) {
            const normalized = query.trim().toLowerCase();
            searchResults.innerHTML = '';
            if (!normalized) {
                return;
            }
            const results = searchIndex.filter(item => item.exerciseName.toLowerCase().includes(normalized)).slice(0, 30);
            if (results.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'text-gray-400';
                empty.textContent = 'No exercises found. Try another keyword.';
                searchResults.appendChild(empty);
                return;
            }
            results.forEach(item => {
                const card = document.createElement('button');
                card.className = 'search-result w-full text-left p-4 rounded-xl bg-gray-800 hover:bg-gray-750';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm uppercase tracking-wider text-blue-300">${item.programTitle}</p>
                            <p class="text-lg font-semibold text-white">${item.exerciseName}</p>
                            <p class="text-sm text-gray-300">Week ${item.week}, Day ${item.day} – ${item.dayTitle}</p>
                            ${item.notes ? `<p class="text-xs text-gray-400 mt-1">${item.notes}</p>` : ''}
                        </div>
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                `;
                card.onclick = () => {
                    resumeProgress(item.programId, item.week, item.day);
                };
                searchResults.appendChild(card);
            });
        }

        // --- PAGE NAVIGATION & STATE ---
        let currentPage = '';
        let currentProgram = '';
        let currentWeek = 0;
        let currentDay = 0;

        function showPage(pageId) {
            if (currentPage === pageId) {
                return;
            }

            const currentPageElement = document.getElementById(currentPage);
            if (currentPageElement) {
                currentPageElement.classList.remove('entered');
                currentPageElement.classList.add('leaving');
                setTimeout(() => {
                    currentPageElement.classList.remove('active', 'leaving');
                }, 250);
            }
            
            const nextPageElement = document.getElementById(pageId);
            if (!nextPageElement) {
                console.error("Page not found:", pageId);
                return;
            }

            nextPageElement.classList.add('active', 'entering');
            requestAnimationFrame(() => {
                nextPageElement.classList.remove('entering');
                nextPageElement.classList.add('entered');
            });
            
            currentPage = pageId;

            // Scroll to top of new page's content
            const content = nextPageElement.querySelector('.page-content');
            if (content) {
                content.scrollTo(0, 0);
            }
        }

        // --- APP LOGIC ---

        // (Step 1) Show list of Weeks for a Program
        function showProgram(programName) {
            currentProgram = programName;
            const program = programs[programName];

            if (!program || (program.weeks && program.weeks.length === 0)) {
                // For 'nippard' or any other empty program
                if (programName === 'nippard') {
                     showMessage(`Program data for ${program.title} is not loaded yet.`);
                } else {
                    // This handles 'gethin' if data was missing
                     document.getElementById('program-title').textContent = program.title;
                     const weekList = document.getElementById('week-list');
                     weekList.innerHTML = ''; // Clear old list
                     // We know Gethin has 12 weeks from the PDF
                     let totalWeeks = 12;
                     
                     for (let i = 1; i <= totalWeeks; i++) {
                        const weekButton = document.createElement('button');
                        const weekDataExists = program.weeks.find(w => w.week === i);
                        
                        weekButton.className = 'btn-press w-full text-left p-5 bg-gray-800 rounded-lg border border-gray-700 shadow-md flex justify-between items-center';
                        
                        let weekHTML = `<span class="text-lg font-semibold text-white">Week ${i}</span>`;
                        
                        if (!weekDataExists) {
                            weekButton.disabled = true;
                            weekButton.className += ' opacity-50';
                            weekHTML += `<span class="text-xs text-gray-500">Not Loaded</span>`;
                        } else {
                            weekHTML += `<svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`;
                            weekButton.onclick = () => showWeek(programName, i);
                        }
                        
                        weekButton.innerHTML = weekHTML;
                        weekList.appendChild(weekButton);
                    }
                }
            } else if (program) {
                 // This is the normal path for Gethin
                 document.getElementById('program-title').textContent = program.title;
                 const weekList = document.getElementById('week-list');
                 weekList.innerHTML = '';
                 let totalWeeks = 12; // Gethin's program is 12 weeks
                 
                 for (let i = 1; i <= totalWeeks; i++) {
                    const weekButton = document.createElement('button');
                    const weekDataExists = program.weeks.find(w => w.week === i);
                    
                    weekButton.className = 'btn-press w-full text-left p-5 bg-gray-800 rounded-lg border border-gray-700 shadow-md flex justify-between items-center';
                    let weekHTML = `<span class="text-lg font-semibold text-white">Week ${i}</span>`;
                    
                    if (!weekDataExists) {
                        weekButton.disabled = true;
                        weekButton.className += ' opacity-50';
                        weekHTML += `<span class="text-xs text-gray-500">Not Loaded</span>`;
                    } else {
                        weekHTML += `<svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`;
                        weekButton.onclick = () => showWeek(programName, i);
                    }
                    
                    weekButton.innerHTML = weekHTML;
                    weekList.appendChild(weekButton);
                }
            } else {
                 showMessage(`Program ${programName} not found.`);
                 return;
            }

            showPage('page-program-weeks');
        }

        // (Step 2) Show list of Days for a Week
        function showWeek(programName, weekNumber) {
            currentWeek = weekNumber;
            const program = programs[programName];
            const week = program.weeks.find(w => w.week === weekNumber);

            if (!week) {
                showMessage(`Workout data for Week ${weekNumber} is not loaded.`);
                return;
            }

            document.getElementById('week-title').textContent = `Week ${weekNumber}`;
            const dayList = document.getElementById('day-list');
            dayList.innerHTML = ''; // Clear old list

            week.days.forEach(day => {
                const dayButton = document.createElement('button');
                dayButton.className = 'btn-press w-full text-left p-5 bg-gray-800 rounded-lg border border-gray-700 shadow-md';
                dayButton.onclick = () => showDay(programName, weekNumber, day.day);

                dayButton.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-sm text-blue-400 font-semibold">Day ${day.day}</span>
                            <p class="text-lg font-semibold text-white">${day.title}</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                `;
                dayList.appendChild(dayButton);
            });
            
            showPage('page-week-days');
        }

        // (Step 3) Show the Workout for a specific Day
        function showDay(programName, weekNumber, dayNumber) {
            currentDay = dayNumber;
            const program = programs[programName];
            const week = program.weeks.find(w => w.week === weekNumber);
            const day = week.days.find(d => d.day === dayNumber);

            document.getElementById('day-title').textContent = `Day ${dayNumber}: ${day.title}`;
            
            const workoutContent = document.getElementById('workout-content');
            workoutContent.innerHTML = ''; // Clear old content

            // 1. Add Cardio
            workoutContent.innerHTML += `
                <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                    <h2 class="text-xl font-bold text-white mb-2">Cardio</h2>
                    <p class="text-lg text-gray-300">${day.cardio}</p>
                </div>
            `;
            
            // 2. Add Weekly Task
            workoutContent.innerHTML += `
                <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                    <h2 class="text-xl font-bold text-white mb-2">Weekly Task</h2>
                    <p class="text-lg text-gray-300">${week.task}</p>
                </div>
            `;

            // 2.5 Training Notes
            const noteCard = document.createElement('div');
            noteCard.className = 'bg-gray-800 rounded-lg p-4 border border-gray-700 space-y-3';
            const noteTitle = document.createElement('h2');
            noteTitle.className = 'text-xl font-bold text-white';
            noteTitle.textContent = 'Training Notes';
            const noteSubtitle = document.createElement('p');
            noteSubtitle.className = 'text-sm text-gray-400';
            noteSubtitle.textContent = 'Capture weights, pacing, or how you felt.';
            const noteTextarea = document.createElement('textarea');
            noteTextarea.className = 'w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none';
            noteTextarea.rows = 4;
            noteTextarea.value = getDayNote(programName, weekNumber, dayNumber);

            let noteSaveTimer;
            noteTextarea.addEventListener('input', (event) => {
                clearTimeout(noteSaveTimer);
                const value = event.target.value;
                noteSaveTimer = setTimeout(() => {
                    setDayNote(programName, weekNumber, dayNumber, value);
                }, 250);
            });

            const previousHistory = historyCache.find(entry => entry.programId === programName && entry.week === weekNumber && entry.summary && entry.summary[String(dayNumber)]);
            const historyBlock = document.createElement('div');
            historyBlock.className = 'bg-gray-900 border border-gray-800 rounded-lg p-3';
            if (previousHistory) {
                const date = new Date(previousHistory.timestamp).toLocaleDateString();
                historyBlock.innerHTML = `
                    <p class="text-xs uppercase tracking-wider text-gray-500">Previously Logged</p>
                    <p class="text-sm text-gray-300">${previousHistory.summary[String(dayNumber)]}</p>
                    <p class="text-xs text-gray-500 mt-2">Completed on ${date}</p>
                `;
            } else {
                historyBlock.innerHTML = `
                    <p class="text-xs uppercase tracking-wider text-gray-500">Previously Logged</p>
                    <p class="text-sm text-gray-400">Complete this week to start building history.</p>
                `;
            }

            noteCard.appendChild(noteTitle);
            noteCard.appendChild(noteSubtitle);
            noteCard.appendChild(noteTextarea);
            noteCard.appendChild(historyBlock);
            workoutContent.appendChild(noteCard);

            // 3. Add Exercises
            if (day.exercises && day.exercises.length > 0) {
                const exerciseList = document.createElement('div');
                exerciseList.className = 'space-y-4';
                
                day.exercises.forEach(ex => {
                    exerciseList.innerHTML += `
                        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 shadow-md">
                            <h3 class="text-2xl font-semibold text-blue-400 mb-2">${ex.name}</h3>
                            <div class="grid grid-cols-3 gap-2 text-center mb-3">
                                <div>
                                    <p class="text-sm text-gray-400">SETS</p>
                                    <p class="text-2xl font-semibold">${ex.sets}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-400">REPS</p>
                                    <p class="text-2xl font-semibold">${ex.reps}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-400">REST</p>
                                    <p class="text-2xl font-semibold">${ex.rest}</p>
                                </div>
                            </div>
                            ${ex.notes ? `<p class="text-sm text-gray-400 italic mt-2">Note: ${ex.notes}</p>` : ''}
                        </div>
                    `;
                });
                workoutContent.appendChild(exerciseList);
            }
            
            showPage('page-workout-details');

            saveProgress({
                programId: programName,
                week: weekNumber,
                day: dayNumber,
                dayTitle: day.title
            });
            updateContinueCard();
        }

        function completeWorkout() {
            if (!currentProgram || !currentWeek) {
                showMessage("Workout complete!");
                return;
            }

            showMessage("Workout complete!");

            const program = programs[currentProgram];
            const weekData = program && program.weeks ? program.weeks.find(w => w.week === currentWeek) : null;
            const days = weekData && Array.isArray(weekData.days) ? weekData.days : [];
            const lastDayNumber = days.length ? days[days.length - 1].day : null;
            const isFinalDay = lastDayNumber === currentDay;
            const weekNotes = getWeekNotes(currentProgram, currentWeek);
            const hasNotes = Object.keys(weekNotes).length > 0;

            if (isFinalDay && hasNotes) {
                logWeekCompletion(currentProgram, currentWeek, weekNotes);
                showSummaryModal(currentProgram, currentWeek, weekNotes);
                pendingNavigation = { type: 'week', program: currentProgram, week: currentWeek };
            } else {
                showWeek(currentProgram, currentWeek);
            }
        }

        // Custom message function
        function showMessage(text) {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            
            messageText.textContent = text;
            messageBox.classList.remove('hidden');

            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 2000);
        }

        // --- PROGRESS SAVING (Coming soon) ---
        // We'll use localStorage to save the current program and week

        // Initialize the app on first load
        showPage('page-main-menu');
        updateContinueCard();
        buildSearchIndex();

        continueBtn.addEventListener('click', () => {
            const programId = continueBtn.dataset.program;
            const week = Number(continueBtn.dataset.week);
            const day = Number(continueBtn.dataset.day);
            resumeProgress(programId, week, day);
        });
        resetProgressBtn.addEventListener('click', () => {
            clearProgress();
        });

        openSearchBtn.addEventListener('click', () => {
            searchOverlay.classList.add('active');
            searchInput.focus();
            searchInput.value = '';
            searchResults.innerHTML = '';
        });
        closeSearchBtn.addEventListener('click', () => {
            searchOverlay.classList.remove('active');
        });
        searchInput.addEventListener('input', (e) => {
            renderSearchResults(e.target.value);
        });
        searchOverlay.addEventListener('click', (e) => {
            if (e.target === searchOverlay) {
                searchOverlay.classList.remove('active');
            }
        });
        if (openStatsBtn) {
            openStatsBtn.addEventListener('click', showStatsOverlay);
        }
        if (quickExportBtn) {
            quickExportBtn.addEventListener('click', triggerExport);
        }
        if (closeStatsBtn) {
            closeStatsBtn.addEventListener('click', hideStatsOverlay);
        }
        if (statsOverlay) {
            statsOverlay.addEventListener('click', (e) => {
                if (e.target === statsOverlay) {
                    hideStatsOverlay();
                }
            });
        }
        if (exportDataBtn) {
            exportDataBtn.addEventListener('click', triggerExport);
        }
        if (importDataBtn && importInput) {
            importDataBtn.addEventListener('click', () => importInput.click());
            importInput.addEventListener('change', async (event) => {
                const file = event.target.files && event.target.files[0];
                if (file) {
                    try {
                        await handleImportFile(file);
                    } catch (err) {
                        // errors already surfaced via showMessage
                    } finally {
                        importInput.value = '';
                    }
                }
            });
        }
        closeSummaryBtn.addEventListener('click', hideSummaryModal);
        summaryOverlay.addEventListener('click', (e) => {
            if (e.target === summaryOverlay) {
                hideSummaryModal();
            }
        });
    </script>
</body>
</html>