<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <!-- These tags are what make it feel like a PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sculpted Fitness Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent; /* Removes blue flash on tap */
            background-color: #111827; /* Same as bg-gray-900 */
            color: #e5e7eb; /* Same as text-gray-200 */
            min-height: 100vh;
            position: relative;
        }
        .btn-press {
            transition: all 0.1s ease;
        }
        .btn-press:active {
            transform: scale(0.98);
            filter: brightness(0.9);
        }
        
        /* Page Navigation System */
        .no-js .page {
            position: static;
            display: block;
            animation: none;
            padding: 1.5rem;
        }
        .no-js .page + .page {
            margin-top: 2rem;
        }
        .js-enabled .page {
            display: none; /* Hidden by default when JS is enabled */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transform: translateY(16px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .js-enabled .page.active {
            display: block; /* Show active page */
        }
        .js-enabled .page.entering {
            opacity: 0;
            transform: translateY(16px);
        }
        .js-enabled .page.entered {
            opacity: 1;
            transform: translateY(0);
        }
        .js-enabled .page.leaving {
            opacity: 0;
            transform: translateY(-16px);
        }
        .page-content {
            height: 100vh;
            overflow-y: auto;
            /* Added more bottom padding for the 'Complete' button */
            padding: 1.5rem 1.5rem 8rem 1.5rem; 
        }
        .no-js .page-content {
            height: auto;
            overflow: visible;
            padding: 1rem 0;
        }
        /* Style for the header on sub-pages */
        .page-header {
            position: sticky;
            top: 0;
            /* This is the same as bg-gray-900 */
            background-color: #111827; 
            padding-top: 1.5rem;
            padding-bottom: 1rem;
            /* This is the same as border-gray-700 */
            border-bottom: 1px solid #374151; 
            z-index: 10;
        }
        .continue-card {
            border: 1px solid #2563eb33;
            background: linear-gradient(135deg, rgba(37,99,235,0.15), rgba(59,130,246,0.05));
        }
        .trainer-card {
            position: relative;
            overflow: hidden;
            padding: 0;
            background-color: #1f2937;
        }
        .trainer-card-bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            opacity: 0.35;
            transition: opacity 0.2s ease;
        }
        .trainer-card-shade {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(17,24,39,0.8), rgba(37,99,235,0.15));
            transition: opacity 0.2s ease;
        }
        .trainer-card:hover .trainer-card-bg {
            opacity: 0.5;
        }
        .trainer-card:hover .trainer-card-shade {
            opacity: 0.7;
        }
        .search-trigger {
            border: 1px solid #374151;
        }
        .search-overlay {
            position: fixed;
            inset: 0;
            background: rgba(17,24,39,0.95);
            display: none;
            flex-direction: column;
            padding: 2.5rem 1.5rem;
            z-index: 50;
        }
        .search-overlay.active {
            display: flex;
        }
        .search-input {
            background-color: #1f2937;
            border: 1px solid #374151;
        }
        .search-result {
            border: 1px solid #1f2937;
        }
        .stats-overlay {
            position: fixed;
            inset: 0;
            background: rgba(17,24,39,0.92);
            display: none;
            flex-direction: column;
            padding: 2.5rem 1.5rem;
            z-index: 55;
        }
        .stats-overlay.active {
            display: flex;
        }
    </style>
</head>
<body class="no-js h-full text-gray-200 antialiased">

    <!-- Page 1: Main Menu -->
    <div id="page-main-menu" class="page active">
        <div class="flex flex-col h-full items-center justify-center p-6 bg-gray-900">
            <header class="text-center mb-12">
                <h1 class="text-4xl font-bold text-white mb-2">Sculpted Fitness Tracker</h1>
                <p class="text-lg text-gray-400">Your personal program tracker.</p>
            </header>
            <main class="w-full max-w-xl space-y-6">
                <div class="flex items-center justify-between">
                    <div class="text-left">
                        <p class="text-sm uppercase tracking-widest text-blue-400">Welcome Back</p>
                        <p class="text-2xl font-semibold text-white">Your Programs</p>
                    </div>
                    <button id="open-search" class="search-trigger btn-press px-4 py-2 rounded-xl flex items-center text-sm font-medium text-blue-300 hover:text-white">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M10 18a8 8 0 100-16 8 8 0 000 16z"></path></svg>
                        Search Workouts
                    </button>
                </div>

                <div id="continue-card" class="continue-card hidden rounded-2xl p-5 flex flex-col md:flex-row md:items-center md:justify-between">
                    <div class="mb-4 md:mb-0">
                        <p class="text-sm uppercase tracking-wider text-blue-300">Continue</p>
                        <p id="continue-title" class="text-lg font-semibold text-white"></p>
                        <p id="continue-subtitle" class="text-sm text-gray-300"></p>
                    </div>
                    <div class="space-y-2 md:space-y-0 md:space-x-3 md:flex">
                        <button id="continue-btn" class="btn-press bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">Resume Workout</button>
                        <button id="reset-progress" class="btn-press text-sm text-gray-300 hover:text-white px-4 py-2 rounded-lg border border-transparent">Reset</button>
                    </div>
                </div>

                <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider text-center mb-4">Select a Trainer</h2>
                <div id="trainer-card-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>

                <div class="space-y-4">
                    <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6 shadow-lg flex flex-col md:flex-row md:items-center md:justify-between">
                        <div class="mb-4 md:mb-0">
                            <p class="text-sm uppercase tracking-wider text-blue-300">Progress Hub</p>
                            <p class="text-lg font-semibold text-white">Visualize & Backup Your Journey</p>
                            <p class="text-sm text-gray-400">Review completed weeks, compare past runs, and export your data at any time.</p>
                        </div>
                        <div class="space-y-3 md:space-y-0 md:space-x-3 md:flex">
                            <button id="open-stats" class="btn-press bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">View Progress</button>
                            <button id="quick-export" class="btn-press px-4 py-2 rounded-lg border border-gray-600 text-sm text-gray-200 hover:text-white">Quick Export</button>
                        </div>
                    </div>
                    <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6 shadow-lg flex flex-col md:flex-row md:items-center md:justify-between">
                        <div class="mb-4 md:mb-0">
                            <p class="text-sm uppercase tracking-wider text-blue-300">Meal Prep</p>
                            <p class="text-lg font-semibold text-white">Nutrition Hub</p>
                            <p class="text-sm text-gray-400">Browse recipes, plan meals, and generate shopping lists from the 80 Wholefoods guide.</p>
                        </div>
                        <div>
                            <a href="nutrition.html" class="btn-press inline-flex items-center bg-blue-500/20 hover:bg-blue-500/30 text-blue-200 text-sm font-medium rounded-xl px-4 py-2">Open Nutrition Hub</a>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Page 2: Trainer Programs -->
    <div id="page-trainer-programs" class="page">
        <div class="page-content bg-gray-900">
            <header class="page-header flex items-center justify-between mb-6">
                <button onclick="showPage('page-main-menu')" class="btn-press flex items-center text-blue-400 text-lg">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Home
                </button>
                <h1 id="trainer-title" class="text-2xl font-bold text-white text-right"></h1>
            </header>
            <main id="trainer-program-list" class="space-y-3"></main>
        </div>
    </div>

    <!-- Page 3: Week List -->
    <div id="page-program-weeks" class="page">
        <div class="page-content bg-gray-900">
            <header class="page-header flex items-center justify-between mb-6">
                <button onclick="goToTrainerPage()" class="btn-press flex items-center text-blue-400 text-lg">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Trainers
                </button>
                <h1 id="program-title" class="text-2xl font-bold text-white text-right"></h1>
            </header>
            <main id="week-list" class="space-y-3"></main>
        </div>
    </div>

    <!-- Page 3: Day List -->
    <div id="page-week-days" class="page">
        <div class="page-content bg-gray-900">
            <header class="page-header flex items-center justify-between mb-6">
                <button onclick="showProgram(currentProgram)" class="btn-press flex items-center text-blue-400 text-lg">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Weeks
                </button>
                <h1 id="week-title" class="text-2xl font-bold text-white text-right"></h1>
            </header>
            <main id="day-list" class="space-y-3"></main>
        </div>
    </div>

    <!-- Page 4: Workout Details -->
    <div id="page-workout-details" class="page">
        <div class="page-content bg-gray-900">
            <header class="page-header flex items-center justify-between mb-6">
                <button onclick="showWeek(currentProgram, currentWeek)" class="btn-press flex items-center text-blue-400 text-lg">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Days
                </button>
                <h1 id="day-title" class="text-xl font-bold text-white text-right"></h1>
            </header>
            
            <!-- Main workout content -->
            <main id="workout-content" class="space-y-6"></main>

            <!-- Complete button -->
            <div class="fixed bottom-0 left-0 right-0 p-4 bg-gray-900 border-t border-gray-700">
                <button onclick="completeWorkout()" class="btn-press w-full py-4 px-6 bg-blue-600 hover:bg-blue-700 text-white text-lg font-semibold rounded-xl shadow-lg">
                    Complete Workout
                </button>
            </div>
        </div>
    </div>

    <!-- Message box for alerts -->
    <div id="message-box" class="hidden fixed bottom-24 left-1/2 -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-xl shadow-lg z-50">
        <p id="message-text"></p>
    </div>

    <!-- Weekly Summary Modal -->
    <div id="summary-overlay" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl max-w-xl w-full p-6 space-y-5 shadow-2xl">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-sm uppercase tracking-widest text-blue-400">Weekly Snapshot</p>
                    <h2 id="summary-title" class="text-2xl font-semibold text-white"></h2>
                </div>
                <button id="close-summary" class="btn-press text-gray-400 hover:text-white">Close</button>
            </div>
            <div class="bg-gray-800 rounded-xl border border-gray-700 p-4 space-y-3">
                <div>
                    <p class="text-xs uppercase tracking-wider text-gray-400">Cardio Completed</p>
                    <p id="summary-cardio" class="text-lg font-semibold text-white"></p>
                </div>
                <div>
                    <p class="text-xs uppercase tracking-wider text-gray-400">Weekly Task</p>
                    <p id="summary-task" class="text-sm text-gray-300"></p>
                </div>
                <div>
                    <p class="text-xs uppercase tracking-wider text-gray-400">Notes Entered</p>
                    <ul id="summary-notes" class="text-sm text-gray-300 space-y-1"></ul>
                </div>
            </div>
            <div>
                <p class="text-xs uppercase tracking-wider text-gray-400">Historical Notes</p>
                <div id="summary-history" class="bg-gray-800 rounded-xl border border-gray-700 p-4 space-y-3 max-h-48 overflow-y-auto text-sm text-gray-300"></div>
            </div>
        </div>
    </div>

    <!-- Stats & Backup Overlay -->
    <div id="stats-overlay" class="stats-overlay">
        <div class="flex items-center justify-between mb-6">
            <div>
                <p class="text-sm uppercase tracking-widest text-blue-400">Progress & Backup</p>
                <h2 class="text-2xl font-semibold text-white">Your Training History</h2>
            </div>
            <button id="close-stats" class="btn-press text-gray-400 hover:text-white">Close</button>
        </div>
        <div id="stats-empty" class="flex-1 flex items-center justify-center text-gray-500 text-center hidden">
            <div>
                <p class="text-lg font-semibold text-gray-300">No completed weeks yet.</p>
                <p class="text-sm text-gray-400 mt-2">Log notes and finish a week to start building your history.</p>
            </div>
        </div>
        <div id="stats-content" class="flex-1 space-y-6 overflow-y-auto">
            <div class="bg-gray-900 border border-gray-700 rounded-2xl p-4">
                <canvas id="progress-chart" height="220"></canvas>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-gray-900 border border-gray-700 rounded-2xl p-4">
                    <p class="text-xs uppercase tracking-wider text-gray-400">Totals</p>
                    <div class="mt-3 space-y-2">
                        <p class="text-sm text-gray-300">Completed Weeks: <span id="stats-weeks" class="text-blue-300 font-semibold">0</span></p>
                        <p class="text-sm text-gray-300">Notes Captured: <span id="stats-notes" class="text-blue-300 font-semibold">0</span></p>
                        <p class="text-sm text-gray-300">Programs Logged: <span id="stats-programs" class="text-blue-300 font-semibold">0</span></p>
                    </div>
                </div>
                <div class="bg-gray-900 border border-gray-700 rounded-2xl p-4 space-y-3">
                    <p class="text-xs uppercase tracking-wider text-gray-400">Backup & Restore</p>
                    <p class="text-sm text-gray-400">Export your notes, progress, and history for safe keeping—or import a previous backup to restore everything.</p>
                    <div class="space-y-2">
                        <button id="export-data" class="btn-press w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">Download Backup</button>
                        <button id="import-data" class="btn-press w-full px-4 py-2 rounded-lg border border-gray-600 text-sm text-gray-200 hover:text-white">Import Backup</button>
                        <input type="file" id="import-input" accept="application/json" class="hidden" />
                    </div>
                </div>
            </div>
            <div class="bg-gray-900 border border-gray-700 rounded-2xl p-4">
                <p class="text-xs uppercase tracking-wider text-gray-400">Recent History</p>
                <div id="stats-history" class="mt-3 space-y-3 text-sm text-gray-300"></div>
            </div>
        </div>
    </div>

    <!-- ThenX Library Page -->
    <div id="page-thenx-library" class="page">
        <div class="page-header px-6">
            <div class="flex items-center justify-between">
                <button id="thenx-library-back" class="btn-press text-sm text-gray-300 hover:text-white flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Back to Trainer
                </button>
                <div class="text-right">
                    <p class="text-xs uppercase tracking-wider text-blue-300">Calisthenics Library</p>
                    <h1 id="thenx-library-title" class="text-2xl font-semibold text-white">ThenX Calisthenics Library</h1>
                </div>
            </div>
        </div>
        <div class="page-content space-y-6">
            <div class="bg-gray-900 border border-gray-700 rounded-2xl p-5 space-y-4">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <p id="thenx-library-summary" class="text-sm text-gray-300">Explore signature bodyweight circuits curated from ThenX featured workouts. Type in a body part you want to workout! There are also Beginner, Intermediate, and Hard difficulty on the website!</p>
                    <div class="w-full md:w-80">
                        <input id="thenx-search-input" type="text" placeholder="Search workouts..." class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                </div>
                <div id="thenx-focus-chips" class="flex flex-wrap gap-2"></div>
            </div>
            <div id="thenx-library-empty" class="hidden text-center text-gray-400 bg-gray-900 border border-gray-700 rounded-2xl p-8">
                <p class="text-lg font-semibold text-gray-300">No workouts match your filters yet.</p>
                <p class="text-sm text-gray-400 mt-2">Try clearing the filters or searching with a different keyword.</p>
            </div>
            <div id="thenx-workout-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
        </div>
    </div>

    <!-- Search Overlay -->
    <div id="search-overlay" class="search-overlay">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-semibold text-white">Search Exercises</h2>
            <button id="close-search" class="btn-press text-gray-400 hover:text-white text-sm">Close</button>
        </div>
        <div class="mb-6">
            <input id="search-input" type="text" placeholder="Search by exercise name..." class="search-input w-full px-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-white placeholder-gray-500" />
            <p class="text-sm text-gray-400 mt-2">Tip: try "squat", "pulldown", or "DTP".</p>
        </div>
        <div id="search-results" class="overflow-y-auto space-y-3"></div>
    </div>

    <script src="data/thenx-workouts.js"></script>
    <script src="data/program-data.js"></script>
    <script>
        document.body.classList.remove('no-js');
        document.body.classList.add('js-enabled');

        // --- DATABASE ---
        const programs = window.programs || {};
        if (!Object.keys(programs).length) {
            console.warn("Program data is not loaded.");
        }

        const thenxDataset = window.thenxWorkouts || { workouts: [], source: '', updatedAt: '' };
        const thenxLibraryWorkouts = (thenxDataset.workouts || []).map((workout) => {
            const focus = Array.isArray(workout.focus) ? workout.focus : [];
            let level = 'all';
            try {
                const params = new URL(workout.url, window.location.origin).searchParams;
                level = (params.get('level') || 'all').toLowerCase();
            } catch (error) {
                level = 'all';
            }
            return {
                ...workout,
                focus,
                focusLower: focus.map(tag => tag.toLowerCase()),
                level,
            };
        }).sort((a, b) => (b.likes ?? 0) - (a.likes ?? 0));

        const thenxFocusOptions = Array.from(new Set(thenxLibraryWorkouts.flatMap(workout => workout.focusLower))).filter(Boolean).sort();

        if (!programs.thenxLibrary) {
            programs.thenxLibrary = {
                title: "ThenX Calisthenics Library",
                type: "library",
                workouts: thenxLibraryWorkouts,
                source: thenxDataset.source || "https://app.thenx.com/featured-workouts",
                updatedAt: thenxDataset.updatedAt || ''
            };
        }

        const trainers = {
            gethin: {
                name: "Kris Gethin",
                image: "images/kris.PNG",
                programs: [
                    { id: "gethin", subtitle: "Legacy Program", image: "images/gethin_legacy.PNG", imagePosition: "center top 25%" },
                    { id: "kagedLean", subtitle: "Lean Muscle Trainer", image: "images/12_week_lean_muscle.PNG", imagePosition: "center top 28%" },
                    { id: "hardcore8", subtitle: "8-Week Hardcore Trainer", image: "images/hard.core.PNG", imagePosition: "center" }
                ]
            },
            nippard: {
                name: "Jeff Nippard",
                image: "images/jeff.PNG",
                imagePosition: "center top 18%",
                programs: [
                    { id: "nippard", subtitle: "12-Week Program", image: "images/jeff.nippard.program.PNG", imagePosition: "center top 20%" }
                ]
            },
            thenx: {
                name: "Chris Heria",
                image: "images/chris.heria.PNG",
                imagePosition: "center top 25%",
                programs: [
                    { id: "thenxLibrary", subtitle: "Calisthenics Library", image: "images/thenx.cali.libarary.png", imagePosition: "center top" }
                ]
            }
        };

        const PROGRESS_KEY = 'fitnessProgress';
        const NOTES_KEY = 'fitnessNotes';
        const HISTORY_KEY = 'fitnessHistory';
        const trainerCardContainer = document.getElementById('trainer-card-container');
        const trainerProgramList = document.getElementById('trainer-program-list');
        const trainerTitle = document.getElementById('trainer-title');
        const continueCard = document.getElementById('continue-card');
        const continueTitle = document.getElementById('continue-title');
        const continueSubtitle = document.getElementById('continue-subtitle');
        const continueBtn = document.getElementById('continue-btn');
        const resetProgressBtn = document.getElementById('reset-progress');
        const searchOverlay = document.getElementById('search-overlay');
        const openSearchBtn = document.getElementById('open-search');
        const closeSearchBtn = document.getElementById('close-search');
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const thenxLibraryBack = document.getElementById('thenx-library-back');
        const thenxLibraryTitle = document.getElementById('thenx-library-title');
        const thenxLibrarySummary = document.getElementById('thenx-library-summary');
        const thenxFocusChipContainer = document.getElementById('thenx-focus-chips');
        const thenxWorkoutList = document.getElementById('thenx-workout-list');
        const thenxLibraryEmpty = document.getElementById('thenx-library-empty');
        const thenxSearchInput = document.getElementById('thenx-search-input');
        const openStatsBtn = document.getElementById('open-stats');
        let thenxFilterState = { focus: 'all', search: '' };
        const quickExportBtn = document.getElementById('quick-export');
        const statsOverlay = document.getElementById('stats-overlay');
        const closeStatsBtn = document.getElementById('close-stats');
        const exportDataBtn = document.getElementById('export-data');
        const importDataBtn = document.getElementById('import-data');
        const importInput = document.getElementById('import-input');
        const statsEmpty = document.getElementById('stats-empty');
        const statsContent = document.getElementById('stats-content');
        const statsWeeks = document.getElementById('stats-weeks');
        const statsNotes = document.getElementById('stats-notes');
        const statsPrograms = document.getElementById('stats-programs');
        const statsHistoryContainer = document.getElementById('stats-history');
        const progressChartCanvas = document.getElementById('progress-chart');
        const summaryOverlay = document.getElementById('summary-overlay');
        const closeSummaryBtn = document.getElementById('close-summary');
        const summaryTitle = document.getElementById('summary-title');
        const summaryCardio = document.getElementById('summary-cardio');
        const summaryTask = document.getElementById('summary-task');
        const summaryNotes = document.getElementById('summary-notes');
        const summaryHistory = document.getElementById('summary-history');
        let searchIndex = [];
        let notesCache = loadNotes();
        let historyCache = loadHistory();
        let pendingNavigation = null;
        let progressChartInstance = null;

        function loadProgress() {
            try {
                const stored = localStorage.getItem(PROGRESS_KEY);
                return stored ? JSON.parse(stored) : null;
            } catch (err) {
                console.error('Failed to load progress', err);
                return null;
            }
        }

        function loadNotes() {
            try {
                const stored = localStorage.getItem(NOTES_KEY);
                return stored ? JSON.parse(stored) : {};
            } catch (err) {
                console.error('Failed to load notes', err);
                return {};
            }
        }

        function saveNotes(notes) {
            try {
                localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
                notesCache = notes;
            } catch (err) {
                console.error('Failed to save notes', err);
            }
        }

        function loadHistory() {
            try {
                const stored = localStorage.getItem(HISTORY_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (err) {
                console.error('Failed to load history', err);
                return [];
            }
        }

        function saveHistory(history) {
            try {
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                historyCache = history;
            } catch (err) {
                console.error('Failed to save history', err);
            }
        }

        function getWeekNotes(programId, weekNumber) {
            return (notesCache[programId] && notesCache[programId][weekNumber]) ? { ...notesCache[programId][weekNumber] } : {};
        }

        function getDayNote(programId, weekNumber, dayNumber) {
            const programNotes = notesCache[programId];
            if (!programNotes) return '';
            const weekNotes = programNotes[weekNumber];
            if (!weekNotes) return '';
            return weekNotes[dayNumber] || '';
        }

        function setDayNote(programId, weekNumber, dayNumber, value) {
            if (!notesCache[programId]) {
                notesCache[programId] = {};
            }
            if (!notesCache[programId][weekNumber]) {
                notesCache[programId][weekNumber] = {};
            }
            if (value && value.trim()) {
                notesCache[programId][weekNumber][dayNumber] = value.trim();
            } else {
                delete notesCache[programId][weekNumber][dayNumber];
                if (Object.keys(notesCache[programId][weekNumber]).length === 0) {
                    delete notesCache[programId][weekNumber];
                }
            }
            saveNotes(notesCache);
            if (statsOverlay.classList.contains('active')) {
                renderStatsView();
            }
        }

        function collectExportData() {
            return {
                version: 1,
                generatedAt: new Date().toISOString(),
                progress: loadProgress(),
                notes: notesCache,
                history: historyCache
            };
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const anchor = document.createElement('a');
            anchor.href = url;
            anchor.download = filename;
            document.body.appendChild(anchor);
            anchor.click();
            document.body.removeChild(anchor);
            URL.revokeObjectURL(url);
        }

        function triggerExport() {
            const data = collectExportData();
            const timestamp = new Date().toISOString().split('T')[0];
            downloadJSON(data, `sculpted-fitness-backup-${timestamp}.json`);
            showMessage('Backup downloaded');
        }

        function aggregateCurrentNoteCount() {
            let total = 0;
            Object.values(notesCache).forEach(weekMap => {
                if (weekMap && typeof weekMap === 'object') {
                    Object.values(weekMap).forEach(dayNote => {
                        if (typeof dayNote === 'string' && dayNote.trim()) {
                            total += 1;
                        }
                    });
                }
            });
            return total;
        }

        function renderStatsView() {
            if (!statsOverlay) return;

            const hasHistory = historyCache.length > 0;
            const currentNotes = aggregateCurrentNoteCount();

            if (!hasHistory && currentNotes === 0) {
                statsEmpty.classList.remove('hidden');
                statsContent.classList.add('hidden');
                statsHistoryContainer.innerHTML = '';
                statsWeeks.textContent = '0';
                statsNotes.textContent = '0';
                statsPrograms.textContent = '0';
                if (progressChartInstance) {
                    progressChartInstance.destroy();
                    progressChartInstance = null;
                }
                return;
            }

            statsEmpty.classList.add('hidden');
            statsContent.classList.remove('hidden');

            const chronological = historyCache.slice().reverse();
            const labels = chronological.map(entry => `${entry.programTitle || entry.programId} W${entry.week}`);
            const dataPoints = chronological.map(entry => Object.keys(entry.summary || {}).length);

            if (progressChartInstance) {
                progressChartInstance.data.labels = labels;
                progressChartInstance.data.datasets[0].data = dataPoints;
                progressChartInstance.update();
            } else if (progressChartCanvas) {
                const ctx = progressChartCanvas.getContext('2d');
                progressChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: 'Notes Logged per Week',
                                data: dataPoints,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59,130,246,0.15)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.35,
                                pointRadius: 4,
                                pointBackgroundColor: '#60a5fa'
                            }
                        ]
                    },
                    options: {
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#d1d5db'
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#9ca3af'
                                },
                                grid: {
                                    color: 'rgba(55,65,81,0.3)'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#9ca3af',
                                    precision: 0
                                },
                                grid: {
                                    color: 'rgba(55,65,81,0.3)'
                                }
                            }
                        }
                    }
                });
            }

            const totalWeeks = historyCache.length;
            const historyNotes = historyCache.reduce((sum, entry) => sum + Object.keys(entry.summary || {}).length, 0);
            const programSet = new Set(historyCache.map(entry => entry.programId));
            Object.keys(notesCache || {}).forEach(programId => {
                programSet.add(programId);
            });

            statsWeeks.textContent = String(totalWeeks);
            statsNotes.textContent = String(historyNotes + currentNotes);
            statsPrograms.textContent = String(programSet.size);

            const recentEntries = historyCache.slice(0, 6);
            statsHistoryContainer.innerHTML = '';
            recentEntries.forEach(entry => {
                const wrap = document.createElement('div');
                wrap.className = 'bg-gray-800 border border-gray-700 rounded-xl p-3';
                const date = new Date(entry.timestamp).toLocaleString();
                const notes = Object.entries(entry.summary || {});
                wrap.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-semibold text-white">${entry.programTitle || entry.programId} – Week ${entry.week}</p>
                            <p class="text-xs text-gray-400">${date}</p>
                        </div>
                        <span class="text-xs text-blue-300">${notes.length} notes</span>
                    </div>
                    <ul class="mt-3 space-y-1 text-xs text-gray-300">
                        ${notes.map(([day, note]) => `<li><span class="text-blue-300 font-medium">Day ${day}:</span> ${note}</li>`).join('')}
                    </ul>
                `;
                statsHistoryContainer.appendChild(wrap);
            });
        }

        function showStatsOverlay() {
            statsOverlay.classList.add('active');
            renderStatsView();
        }

        function hideStatsOverlay() {
            statsOverlay.classList.remove('active');
        }

        function applyImportedData(payload) {
            if (!payload || typeof payload !== 'object') {
                throw new Error('Invalid backup');
            }

            if (payload.notes && typeof payload.notes === 'object') {
                saveNotes(payload.notes);
            } else {
                saveNotes({});
            }

            if (payload.history && Array.isArray(payload.history)) {
                saveHistory(payload.history);
            } else {
                saveHistory([]);
            }

            if (payload.progress) {
                saveProgress(payload.progress);
            } else {
                localStorage.removeItem(PROGRESS_KEY);
            }

            notesCache = loadNotes();
            historyCache = loadHistory();
            updateContinueCard();
            renderStatsView();
            showMessage('Backup imported');
        }

        function handleImportFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const payload = JSON.parse(event.target.result);
                        applyImportedData(payload);
                        resolve();
                    } catch (err) {
                        console.error('Failed to import backup', err);
                        showMessage('Import failed');
                        reject(err);
                    }
                };
                reader.onerror = err => {
                    console.error('Failed to read file', err);
                    showMessage('Import failed');
                    reject(err);
                };
                reader.readAsText(file);
            });
        }

        function saveProgress(data) {
            try {
                localStorage.setItem(PROGRESS_KEY, JSON.stringify(data));
            } catch (err) {
                console.error('Failed to save progress', err);
            }
        }

        function clearProgress() {
            localStorage.removeItem(PROGRESS_KEY);
            updateContinueCard();
        }

        function updateContinueCard() {
            const progress = loadProgress();
            if (!progress) {
                continueCard.classList.add('hidden');
                return;
            }
            const program = programs[progress.programId];
            if (!program) {
                continueCard.classList.add('hidden');
                return;
            }
            let trainerId = progress.trainerId || findTrainerForProgram(progress.programId);
            if (!progress.trainerId && trainerId) {
                const updated = { ...progress, trainerId };
                saveProgress(updated);
                progress.trainerId = trainerId;
            }
            const trainerName = trainerId && trainers[trainerId] ? trainers[trainerId].name : '';
            continueCard.classList.remove('hidden');
            const headline = trainerName ? `${trainerName} – Week ${progress.week}, Day ${progress.day}` : `${program.title} – Week ${progress.week}, Day ${progress.day}`;
            continueTitle.textContent = headline;
            continueSubtitle.textContent = `${program.title} · ${progress.dayTitle}`;
            continueBtn.dataset.program = progress.programId;
            continueBtn.dataset.week = progress.week;
            continueBtn.dataset.day = progress.day;
            continueBtn.dataset.trainer = trainerId || '';
        }

        function resumeProgress(programId, weekNumber, dayNumber) {
            const trainerId = findTrainerForProgram(programId);
            if (trainerId) {
                currentTrainer = trainerId;
            }
            showProgram(programId);
            showWeek(programId, weekNumber);
            showDay(programId, weekNumber, dayNumber);
            searchOverlay.classList.remove('active');
        }

        function logWeekCompletion(programId, weekNumber, summary) {
            const trainerId = findTrainerForProgram(programId);
            const entry = {
                id: `${programId}-${weekNumber}-${Date.now()}`,
                timestamp: Date.now(),
                programId,
                programTitle: programs[programId]?.title || programId,
                trainerId,
                trainerName: trainerId && trainers[trainerId] ? trainers[trainerId].name : '',
                week: weekNumber,
                summary
            };
            historyCache.unshift(entry);
            if (historyCache.length > 100) {
                historyCache = historyCache.slice(0, 100);
            }
            saveHistory(historyCache);
            if (statsOverlay.classList.contains('active')) {
                renderStatsView();
            }
        }

        function formatCardioSummary(days) {
            const cardioLines = days
                .map(day => day.cardio)
                .filter(Boolean);
            if (!cardioLines.length) return 'No cardio logged this week.';
            const uniqueLines = Array.from(new Set(cardioLines));
            return uniqueLines.join('\n');
        }

        function showSummaryModal(programId, weekNumber, weekNotes) {
            const program = programs[programId];
            if (!program) return;
            const weekData = program.weeks.find(w => w.week === weekNumber);
            if (!weekData) return;

            summaryTitle.textContent = `${program.title} – Week ${weekNumber}`;
            const cardioSummary = formatCardioSummary(weekData.days);
            summaryCardio.innerHTML = cardioSummary.replace(/\n/g, '<br>');
            summaryTask.textContent = weekData.task || 'No weekly task logged.';

            summaryNotes.innerHTML = '';
            const noteEntries = Object.entries(weekNotes || {});
            if (noteEntries.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'No notes entered this week.';
                summaryNotes.appendChild(li);
            } else {
                noteEntries.sort((a, b) => Number(a[0]) - Number(b[0]));
                noteEntries.forEach(([day, note]) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="text-blue-300">Day ${day}:</span> ${note}`;
                    summaryNotes.appendChild(li);
                });
            }

            summaryHistory.innerHTML = '';
            const matchingHistory = historyCache.filter(entry => entry.programId === programId && entry.week === weekNumber);
            if (!matchingHistory.length) {
                const p = document.createElement('p');
                p.className = 'text-gray-400';
                p.textContent = 'No previous runs yet. Complete this week to start building your timeline.';
                summaryHistory.appendChild(p);
            } else {
                matchingHistory.forEach(entry => {
                    const wrap = document.createElement('div');
                    const date = new Date(entry.timestamp).toLocaleString();
                    wrap.innerHTML = `
                        <p class="text-xs text-gray-500">${date}</p>
                        <ul class="text-sm text-gray-300 space-y-1">
                            ${Object.entries(entry.summary).map(([day, note]) => `<li><span class="text-blue-300">Day ${day}:</span> ${note}</li>`).join('')}
                        </ul>
                    `;
                    summaryHistory.appendChild(wrap);
                });
            }

            summaryOverlay.classList.remove('hidden');
        }

        function hideSummaryModal() {
            summaryOverlay.classList.add('hidden');
            if (pendingNavigation && pendingNavigation.type === 'week') {
                showWeek(pendingNavigation.program, pendingNavigation.week);
            }
            pendingNavigation = null;
        }

        function buildSearchIndex() {
            searchIndex = [];
            Object.entries(programs).forEach(([programId, program]) => {
                if (!program || !Array.isArray(program.weeks)) {
                    return;
                }
                program.weeks.forEach(week => {
                    week.days.forEach(day => {
                        const trainerId = findTrainerForProgram(programId);
                        const trainerName = trainerId && trainers[trainerId] ? trainers[trainerId].name : '';
                        day.exercises.forEach(exercise => {
                            searchIndex.push({
                                programId,
                                programTitle: program.title,
                                trainerName,
                                week: week.week,
                                weekTask: week.task,
                                day: day.day,
                                dayTitle: day.title,
                                cardio: day.cardio,
                                exerciseName: exercise.name,
                                notes: exercise.notes
                            });
                        });
                    });
                });
            });
        }

        function renderSearchResults(query) {
            const normalized = query.trim().toLowerCase();
            searchResults.innerHTML = '';
            if (!normalized) {
                return;
            }
            const results = searchIndex.filter(item => item.exerciseName.toLowerCase().includes(normalized)).slice(0, 30);
            if (results.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'text-gray-400';
                empty.textContent = 'No exercises found. Try another keyword.';
                searchResults.appendChild(empty);
                return;
            }
            results.forEach(item => {
                const card = document.createElement('button');
                card.className = 'search-result w-full text-left p-4 rounded-xl bg-gray-800 hover:bg-gray-750';
                const header = item.trainerName ? `${item.trainerName} · ${item.programTitle}` : item.programTitle;
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm uppercase tracking-wider text-blue-300">${header}</p>
                            <p class="text-lg font-semibold text-white">${item.exerciseName}</p>
                            <p class="text-sm text-gray-300">Week ${item.week}, Day ${item.day} – ${item.dayTitle}</p>
                            ${item.notes ? `<p class="text-xs text-gray-400 mt-1">${item.notes}</p>` : ''}
                        </div>
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                `;
                card.onclick = () => {
                    resumeProgress(item.programId, item.week, item.day);
                };
                searchResults.appendChild(card);
            });
        }

        function findTrainerForProgram(programId) {
            return Object.keys(trainers).find(trainerId =>
                trainers[trainerId].programs.some(program => program.id === programId)
            ) || '';
        }

        function formatThenxTag(tag) {
            return tag.split(' ').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join(' ');
        }

        function renderThenxFocusFilters() {
            if (!thenxFocusChipContainer) return;
            const options = ['all', ...thenxFocusOptions];
            thenxFocusChipContainer.innerHTML = '';
            options.forEach(option => {
                const button = document.createElement('button');
                const isActive = thenxFilterState.focus === option;
                button.className = `btn-press px-3 py-1 rounded-full text-xs font-semibold border ${isActive ? 'bg-blue-600 text-white border-blue-500' : 'bg-gray-800 border-gray-700 text-gray-300 hover:border-blue-500'}`;
                button.textContent = option === 'all' ? 'All' : formatThenxTag(option);
                button.addEventListener('click', () => {
                    if (thenxFilterState.focus === option) return;
                    thenxFilterState.focus = option;
                    renderThenxFocusFilters();
                    if (programs.thenxLibrary) {
                        renderThenxLibraryList(programs.thenxLibrary);
                    }
                });
                thenxFocusChipContainer.appendChild(button);
            });
        }

        function renderThenxLibraryList(program) {
            if (!thenxWorkoutList || !program) return;
            const workouts = Array.isArray(program.workouts) ? program.workouts : [];
            const filtered = workouts.filter(workout => {
                const focusLower = workout.focusLower || (Array.isArray(workout.focus) ? workout.focus.map(tag => String(tag).toLowerCase()) : []);
                if (thenxFilterState.focus !== 'all' && !focusLower.includes(thenxFilterState.focus)) {
                    return false;
                }
                if (thenxFilterState.search) {
                    const term = thenxFilterState.search;
                    const titleMatch = workout.title.toLowerCase().includes(term);
                    const focusMatch = focusLower.some(tag => tag.includes(term));
                    if (!titleMatch && !focusMatch) {
                        return false;
                    }
                }
                return true;
            });

            thenxWorkoutList.innerHTML = '';
            if (!filtered.length) {
                if (thenxLibraryEmpty) thenxLibraryEmpty.classList.remove('hidden');
            } else {
                if (thenxLibraryEmpty) thenxLibraryEmpty.classList.add('hidden');
                filtered.forEach(workout => {
                    const card = document.createElement('a');
                    card.href = workout.url;
                    card.target = '_blank';
                    card.rel = 'noopener noreferrer';
                    card.className = 'block bg-gray-900 border border-gray-700 rounded-2xl overflow-hidden transition hover:border-blue-500';
                    const focusBadges = (workout.focus || []).map(tag => `<span class="px-2 py-1 rounded-full bg-gray-900/80 border border-gray-700 text-xs text-gray-200">${formatThenxTag(tag)}</span>`).join('');
                    const backgroundStyle = workout.image ? `background-image: url('${workout.image}'); background-size: cover; background-position: center;` : '';
                    card.innerHTML = `
                        <div class="relative h-40 ${workout.image ? '' : 'bg-gray-800'}" ${backgroundStyle ? `style="${backgroundStyle}"` : ''}>
                            <div class="absolute inset-0 bg-gradient-to-t from-gray-900/90 via-gray-900/30 to-transparent"></div>
                            <div class="absolute top-3 left-3 flex flex-wrap gap-2">${focusBadges}</div>
                            ${workout.date ? `<div class="absolute bottom-3 left-3"><p class="text-xs text-gray-200">${workout.date}</p></div>` : ''}
                        </div>
                        <div class="p-4 space-y-3">
                            <p class="text-lg font-semibold text-white">${workout.title}</p>
                            <div class="flex items-center gap-4 text-xs text-gray-400">
                                <span>❤️ ${workout.likes ?? '—'}</span>
                                <span>💬 ${workout.comments ?? '—'}</span>
                                ${workout.level && workout.level !== 'all' ? `<span class="capitalize">${workout.level}</span>` : ''}
                            </div>
                            <p class="text-sm text-blue-300">Open on ThenX &rarr;</p>
                        </div>
                    `;
                    thenxWorkoutList.appendChild(card);
                });
            }

            if (thenxLibrarySummary) {
                const total = workouts.length;
                const focusLabel = thenxFilterState.focus === 'all' ? 'All focuses' : formatThenxTag(thenxFilterState.focus);
                const updatedLabel = program.updatedAt ? `Updated ${new Date(program.updatedAt).toLocaleDateString()}` : 'Latest refresh';
                thenxLibrarySummary.textContent = `${filtered.length} of ${total} workouts · ${focusLabel} · ${updatedLabel}`;
            }
        }

        function renderThenxLibrary(program) {
            if (!program || !Array.isArray(program.workouts)) {
                showMessage('ThenX workouts are not available yet.');
                return;
            }
            if (thenxLibraryTitle) {
                thenxLibraryTitle.textContent = program.title;
            }
            thenxFilterState = { focus: 'all', search: '' };
            if (thenxSearchInput) {
                thenxSearchInput.value = '';
            }
            renderThenxFocusFilters();
            renderThenxLibraryList(program);
        }

        function renderTrainerCards() {
            if (!trainerCardContainer) return;
            trainerCardContainer.innerHTML = '';
            Object.entries(trainers).forEach(([trainerId, trainer]) => {
                const button = document.createElement('button');
                button.className = 'trainer-card btn-press w-full rounded-2xl shadow-lg border border-gray-700';
                const programSummary = trainer.programs
                    .map(programRef => programRef.subtitle || (programs[programRef.id]?.title ?? ''))
                    .filter(Boolean)
                    .join(' | ');
                const position = trainer.imagePosition || '';
                const bgStyle = trainer.image
                    ? `style="background-image: url('${trainer.image}');${position ? ` background-position: ${position};` : ''}"`
                    : '';
                button.innerHTML = `
                    <div class="trainer-card-bg" ${bgStyle}></div>
                    <div class="trainer-card-shade"></div>
                    <div class="trainer-card-content relative z-10 flex items-center justify-between w-full p-6">
                        <div class="text-left">
                            <p class="text-lg font-semibold text-white">${trainer.name}</p>
                            ${programSummary ? `<p class="text-sm text-gray-200">${programSummary}</p>` : ''}
                        </div>
                        <svg class="w-5 h-5 text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                `;
                button.addEventListener('click', () => {
                    showTrainer(trainerId);
                });
                trainerCardContainer.appendChild(button);
            });
        }

        function showTrainer(trainerId) {
            const trainer = trainers[trainerId];
            if (!trainer) {
                showMessage('Trainer not found.');
                return;
            }
            currentTrainer = trainerId;
            if (trainerTitle) {
                trainerTitle.textContent = trainer.name;
            }
            if (trainerProgramList) {
                trainerProgramList.innerHTML = '';
                trainer.programs.forEach(programRef => {
                    const programData = programs[programRef.id];
                    if (!programData) {
                        return;
                    }
                    const isLibrary = programData.type === 'library';
                    const weeksCount = Array.isArray(programData.weeks) ? programData.weeks.length : 0;
                    const workoutsCount = isLibrary && Array.isArray(programData.workouts) ? programData.workouts.length : 0;
                    if (!isLibrary && weeksCount === 0) {
                        return;
                    }
                    const detailLabel = isLibrary
                        ? `${workoutsCount} workout${workoutsCount === 1 ? '' : 's'}`
                        : `${weeksCount} week${weeksCount === 1 ? '' : 's'}`;
                    const button = document.createElement('button');
                    button.className = 'trainer-card btn-press w-full rounded-2xl shadow-lg border border-gray-700 overflow-hidden';
                    const subtitle = programRef.subtitle && programRef.subtitle !== programData.title ? programRef.subtitle : '';
                    const imagePosition = programRef.imagePosition || '';
                    const bgStyle = programRef.image
                        ? `style="background-image: url('${programRef.image}');${imagePosition ? ` background-position: ${imagePosition};` : ''}"`
                        : '';
                    button.innerHTML = `
                        <div class="trainer-card-bg" ${bgStyle}></div>
                        <div class="trainer-card-shade"></div>
                        <div class="trainer-card-content relative z-10 flex items-center justify-between w-full p-6">
                            <div class="text-left space-y-1">
                                <p class="text-lg font-semibold text-white">${programData.title}</p>
                                ${subtitle ? `<p class="text-sm text-gray-200">${subtitle}</p>` : ''}
                                <p class="text-xs text-gray-400 uppercase tracking-wider">${detailLabel}</p>
                            </div>
                            <svg class="w-5 h-5 text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </div>
                    `;
                    button.addEventListener('click', () => {
                        showProgram(programRef.id);
                    });
                    trainerProgramList.appendChild(button);
                });
            }
            showPage('page-trainer-programs');
        }

        function goToTrainerPage() {
            if (currentTrainer && trainers[currentTrainer]) {
                showTrainer(currentTrainer);
            } else {
                showPage('page-main-menu');
            }
        }

        // --- PAGE NAVIGATION & STATE ---
        let currentTrainer = '';
        let currentPage = '';
        let currentProgram = '';
        let currentWeek = 0;
        let currentDay = 0;

        function showPage(pageId) {
            if (currentPage === pageId) {
                return;
            }

            const currentPageElement = document.getElementById(currentPage);
            if (currentPageElement) {
                currentPageElement.classList.remove('entered');
                currentPageElement.classList.add('leaving');
                setTimeout(() => {
                    currentPageElement.classList.remove('active', 'leaving');
                }, 250);
            }
            
            const nextPageElement = document.getElementById(pageId);
            if (!nextPageElement) {
                console.error("Page not found:", pageId);
                return;
            }

            nextPageElement.classList.add('active', 'entering');
            requestAnimationFrame(() => {
                nextPageElement.classList.remove('entering');
                nextPageElement.classList.add('entered');
            });
            
            currentPage = pageId;

            // Scroll to top of new page's content
            const content = nextPageElement.querySelector('.page-content');
            if (content) {
                content.scrollTo(0, 0);
            }
        }

        // --- APP LOGIC ---

        // (Step 1) Show list of Weeks for a Program
        function showProgram(programName) {
            currentProgram = programName;
            const program = programs[programName];
            if (!program) {
                showMessage(`Program ${programName} not found.`);
                return;
            }

            const derivedTrainer = findTrainerForProgram(programName);
            if (!currentTrainer || !trainers[currentTrainer] || !trainers[currentTrainer].programs.some(p => p.id === programName)) {
                currentTrainer = derivedTrainer;
            }

            if (program.type === 'library') {
                currentWeek = 0;
                currentDay = 0;
                renderThenxLibrary(program);
                showPage('page-thenx-library');
                return;
            }

            if (!program.weeks || !program.weeks.length) {
                showMessage(`Program data for ${program.title} is not loaded yet.`);
                return;
            }

            document.getElementById('program-title').textContent = program.title;
            const weekList = document.getElementById('week-list');
            weekList.innerHTML = '';

            const orderedWeeks = [...program.weeks].sort((a, b) => a.week - b.week);
            orderedWeeks.forEach(week => {
                const weekButton = document.createElement('button');
                weekButton.className = 'btn-press w-full text-left p-5 bg-gray-800 rounded-lg border border-gray-700 shadow-md flex justify-between items-center';
                weekButton.innerHTML = `
                    <span class="text-lg font-semibold text-white">Week ${week.week}</span>
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                `;
                weekButton.addEventListener('click', () => showWeek(programName, week.week));
                weekList.appendChild(weekButton);
            });

            showPage('page-program-weeks');
        }

        function renderThenxLibrary(program) {
            const trainerProgramList = document.getElementById('trainer-program-list');
            if (!trainerProgramList) return;

            trainerProgramList.innerHTML = '';
            program.workouts.forEach(workout => {
                const workoutButton = document.createElement('button');
                workoutButton.className = 'trainer-card btn-press w-full rounded-2xl shadow-lg border border-gray-700 overflow-hidden';
                workoutButton.innerHTML = `
                    <div class="trainer-card-bg" style="background-image: url('${workout.image || ''}'); background-position: center center;"></div>
                    <div class="trainer-card-shade"></div>
                    <div class="trainer-card-content relative z-10 flex items-center justify-between w-full p-6">
                        <div class="text-left space-y-1">
                            <p class="text-lg font-semibold text-white">${workout.name}</p>
                            <p class="text-sm text-gray-200">${workout.description || ''}</p>
                            <p class="text-xs text-gray-400 uppercase tracking-wider">${workout.level || 'All Levels'}</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                `;
                workoutButton.addEventListener('click', () => {
                    showDay(program.id, 1, 1); // Assuming a default week/day for library workouts
                });
                trainerProgramList.appendChild(workoutButton);
            });
        }

        // (Step 2) Show list of Days for a Week
        function showWeek(programName, weekNumber) {
            currentWeek = weekNumber;
            const program = programs[programName];
            const week = program.weeks.find(w => w.week === weekNumber);

            if (!week) {
                showMessage(`Workout data for Week ${weekNumber} is not loaded.`);
                return;
            }

            document.getElementById('week-title').textContent = `Week ${weekNumber}`;
            const dayList = document.getElementById('day-list');
            dayList.innerHTML = ''; // Clear old list

            week.days.forEach(day => {
                const dayButton = document.createElement('button');
                dayButton.className = 'btn-press w-full text-left p-5 bg-gray-800 rounded-lg border border-gray-700 shadow-md';
                dayButton.onclick = () => showDay(programName, weekNumber, day.day);

                dayButton.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-sm text-blue-400 font-semibold">Day ${day.day}</span>
                            <p class="text-lg font-semibold text-white">${day.title}</p>
                        </div>
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                `;
                dayList.appendChild(dayButton);
            });
            
            showPage('page-week-days');
        }

        // (Step 3) Show the Workout for a specific Day
        function showDay(programName, weekNumber, dayNumber) {
            currentDay = dayNumber;
            const program = programs[programName];
            const week = program.weeks.find(w => w.week === weekNumber);
            const day = week.days.find(d => d.day === dayNumber);

            const cardioText = day.cardio && day.cardio.trim() ? day.cardio : "See program guidance for cardio.";
            const weeklyTaskText = week.task && week.task.trim() ? week.task : "See program guidance for this week's focus.";

            document.getElementById('day-title').textContent = `Day ${dayNumber}: ${day.title}`;
            
            const workoutContent = document.getElementById('workout-content');
            workoutContent.innerHTML = ''; // Clear old content

            // 1. Add Cardio
            workoutContent.innerHTML += `
                <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                    <h2 class="text-xl font-bold text-white mb-2">Cardio</h2>
                    <p class="text-lg text-gray-300">${cardioText}</p>
                </div>
            `;
            
            // 2. Add Weekly Task
            workoutContent.innerHTML += `
                <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                    <h2 class="text-xl font-bold text-white mb-2">Weekly Task</h2>
                    <p class="text-lg text-gray-300">${weeklyTaskText}</p>
                </div>
            `;

            if (Array.isArray(day.notes) && day.notes.length) {
                const coachCard = document.createElement('div');
                coachCard.className = 'bg-gray-800 rounded-lg p-4 border border-gray-700 space-y-3';
                const coachTitle = document.createElement('h2');
                coachTitle.className = 'text-xl font-bold text-white';
                coachTitle.textContent = 'Coach Notes';
                coachCard.appendChild(coachTitle);
                day.notes.forEach(noteText => {
                    const paragraph = document.createElement('p');
                    paragraph.className = 'text-sm text-gray-300 leading-relaxed';
                    paragraph.textContent = noteText;
                    coachCard.appendChild(paragraph);
                });
                if (day.url) {
                    const link = document.createElement('a');
                    link.href = day.url;
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    link.className = 'inline-flex items-center gap-2 text-sm text-blue-300 hover:text-blue-100';
                    link.innerHTML = 'View full article &rarr;';
                    coachCard.appendChild(link);
                }
                workoutContent.appendChild(coachCard);
            }

            // 2.5 Training Notes
            const noteCard = document.createElement('div');
            noteCard.className = 'bg-gray-800 rounded-lg p-4 border border-gray-700 space-y-3';
            const noteTitle = document.createElement('h2');
            noteTitle.className = 'text-xl font-bold text-white';
            noteTitle.textContent = 'Training Notes';
            const noteSubtitle = document.createElement('p');
            noteSubtitle.className = 'text-sm text-gray-400';
            noteSubtitle.textContent = 'Capture weights, pacing, or how you felt.';
            const noteTextarea = document.createElement('textarea');
            noteTextarea.className = 'w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none';
            noteTextarea.rows = 4;
            noteTextarea.value = getDayNote(programName, weekNumber, dayNumber);

            let noteSaveTimer;
            noteTextarea.addEventListener('input', (event) => {
                clearTimeout(noteSaveTimer);
                const value = event.target.value;
                noteSaveTimer = setTimeout(() => {
                    setDayNote(programName, weekNumber, dayNumber, value);
                }, 250);
            });

            const previousHistory = historyCache.find(entry => entry.programId === programName && entry.week === weekNumber && entry.summary && entry.summary[String(dayNumber)]);
            const historyBlock = document.createElement('div');
            historyBlock.className = 'bg-gray-900 border border-gray-800 rounded-lg p-3';
            if (previousHistory) {
                const date = new Date(previousHistory.timestamp).toLocaleDateString();
                historyBlock.innerHTML = `
                    <p class="text-xs uppercase tracking-wider text-gray-500">Previously Logged</p>
                    <p class="text-sm text-gray-300">${previousHistory.summary[String(dayNumber)]}</p>
                    <p class="text-xs text-gray-500 mt-2">Completed on ${date}</p>
                `;
            } else {
                historyBlock.innerHTML = `
                    <p class="text-xs uppercase tracking-wider text-gray-500">Previously Logged</p>
                    <p class="text-sm text-gray-400">Complete this week to start building history.</p>
                `;
            }

            noteCard.appendChild(noteTitle);
            noteCard.appendChild(noteSubtitle);
            noteCard.appendChild(noteTextarea);
            noteCard.appendChild(historyBlock);
            workoutContent.appendChild(noteCard);

            // 3. Add Exercises
            if (day.exercises && day.exercises.length > 0) {
                const exerciseList = document.createElement('div');
                exerciseList.className = 'space-y-4';
                
                day.exercises.forEach(ex => {
                    const setsDisplay = (ex.sets !== undefined && ex.sets !== null && ex.sets !== '') ? ex.sets : '--';
                    const repsDisplay = ex.reps && ex.reps.trim() ? ex.reps.trim() : (ex.info && ex.info.trim() ? ex.info.trim() : '--');
                    const restDisplay = ex.rest && ex.rest.trim() ? ex.rest.trim() : '--';
                    const tags = [ex.section, ex.subsection].filter(Boolean);
                    const tagsMarkup = tags.length
                        ? `<div class="flex flex-wrap gap-2 mb-2">${tags.map(tag => `<span class="px-2 py-1 rounded-full bg-gray-900 border border-gray-700 text-xs text-gray-300">${tag}</span>`).join('')}</div>`
                        : '';
                    const infoLine = ex.info && ex.info.trim() && ex.info.trim() !== repsDisplay
                        ? `<p class="text-sm text-gray-400">${ex.info}</p>`
                        : '';
                    const notesLine = ex.notes
                        ? `<p class="text-sm text-gray-400 italic mt-2">Note: ${ex.notes}</p>`
                        : '';

                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 rounded-lg p-4 border border-gray-700 shadow-md space-y-3';
                    card.innerHTML = `
                        ${tagsMarkup}
                        <h3 class="text-2xl font-semibold text-blue-400">${ex.name}</h3>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div>
                                <p class="text-sm text-gray-400">SETS</p>
                                <p class="text-2xl font-semibold">${setsDisplay}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">REPS / FORMAT</p>
                                <p class="text-lg font-semibold">${repsDisplay}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">REST</p>
                                <p class="text-lg font-semibold">${restDisplay}</p>
                            </div>
                        </div>
                        ${infoLine}
                        ${notesLine}
                    `;
                    exerciseList.appendChild(card);
                });
                workoutContent.appendChild(exerciseList);
            }
            
            showPage('page-workout-details');

            saveProgress({
                programId: programName,
                trainerId: currentTrainer || findTrainerForProgram(programName),
                week: weekNumber,
                day: dayNumber,
                dayTitle: day.title
            });
            updateContinueCard();
        }

        function completeWorkout() {
            if (!currentProgram || !currentWeek) {
                showMessage("Workout complete!");
                return;
            }

            showMessage("Workout complete!");

            const program = programs[currentProgram];
            const weekData = program && program.weeks ? program.weeks.find(w => w.week === currentWeek) : null;
            const days = weekData && Array.isArray(weekData.days) ? weekData.days : [];
            const lastDayNumber = days.length ? days[days.length - 1].day : null;
            const isFinalDay = lastDayNumber === currentDay;
            const weekNotes = getWeekNotes(currentProgram, currentWeek);
            const hasNotes = Object.keys(weekNotes).length > 0;

            if (isFinalDay && hasNotes) {
                logWeekCompletion(currentProgram, currentWeek, weekNotes);
                showSummaryModal(currentProgram, currentWeek, weekNotes);
                pendingNavigation = { type: 'week', program: currentProgram, week: currentWeek };
            } else {
                showWeek(currentProgram, currentWeek);
            }
        }

        // Custom message function
        function showMessage(text) {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            
            messageText.textContent = text;
            messageBox.classList.remove('hidden');

            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 2000);
        }

        // --- PROGRESS SAVING (Coming soon) ---
        // We'll use localStorage to save the current program and week

        // Initialize the app on first load
        showPage('page-main-menu');
        updateContinueCard();
        buildSearchIndex();
        renderTrainerCards();

        continueBtn.addEventListener('click', () => {
            const programId = continueBtn.dataset.program;
            const week = Number(continueBtn.dataset.week);
            const day = Number(continueBtn.dataset.day);
            if (continueBtn.dataset.trainer) {
                currentTrainer = continueBtn.dataset.trainer;
            }
            resumeProgress(programId, week, day);
        });
        resetProgressBtn.addEventListener('click', () => {
            clearProgress();
        });

        openSearchBtn.addEventListener('click', () => {
            searchOverlay.classList.add('active');
            searchInput.focus();
            searchInput.value = '';
            searchResults.innerHTML = '';
        });
        closeSearchBtn.addEventListener('click', () => {
            searchOverlay.classList.remove('active');
        });
        searchInput.addEventListener('input', (e) => {
            renderSearchResults(e.target.value);
        });
        searchOverlay.addEventListener('click', (e) => {
            if (e.target === searchOverlay) {
                searchOverlay.classList.remove('active');
            }
        });
        if (openStatsBtn) {
            openStatsBtn.addEventListener('click', showStatsOverlay);
        }
        if (quickExportBtn) {
            quickExportBtn.addEventListener('click', triggerExport);
        }
        if (closeStatsBtn) {
            closeStatsBtn.addEventListener('click', hideStatsOverlay);
        }
        if (statsOverlay) {
            statsOverlay.addEventListener('click', (e) => {
                if (e.target === statsOverlay) {
                    hideStatsOverlay();
                }
            });
        }
        if (exportDataBtn) {
            exportDataBtn.addEventListener('click', triggerExport);
        }
        if (importDataBtn && importInput) {
            importDataBtn.addEventListener('click', () => importInput.click());
            importInput.addEventListener('change', async (event) => {
                const file = event.target.files && event.target.files[0];
                if (file) {
                    try {
                        await handleImportFile(file);
                    } catch (err) {
                        // errors already surfaced via showMessage
                    } finally {
                        importInput.value = '';
                    }
                }
            });
        }
        closeSummaryBtn.addEventListener('click', hideSummaryModal);
        summaryOverlay.addEventListener('click', (e) => {
            if (e.target === summaryOverlay) {
                hideSummaryModal();
            }
        });

        if (thenxLibraryBack) {
            thenxLibraryBack.addEventListener('click', () => {
                goToTrainerPage();
            });
        }
        if (thenxSearchInput) {
            thenxSearchInput.addEventListener('input', (event) => {
                thenxFilterState.search = event.target.value.trim().toLowerCase();
                if (programs.thenxLibrary) {
                    renderThenxLibraryList(programs.thenxLibrary);
                }
            });
        }
    </script>
</body>
</html>